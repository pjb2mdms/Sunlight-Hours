<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sunlight Angle Comparator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
    }
    header {
      background: #004c91;
      color: white;
      text-align: center;
      padding: 1rem 0;
    }
    main {
      background: white;
      max-width: 1100px;
      margin: 1rem auto;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    h2 { margin-top: 1.2rem; }

    /* Date section */
    .date-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .date-row label {
      font-weight: bold;
    }
    .date-row input {
      padding: 0.4rem;
    }

    .city-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.25rem;
      margin-bottom: 0.5rem;
    }

    button {
      background: #004c91;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 1rem;
    }

    /* City comparison table */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem;
      text-align: center;
    }
    th.city-col {
      transform: rotate(-45deg);
      white-space: nowrap;
      height: 100px;
      vertical-align: bottom;
      padding: 0;
      font-size: 0.85rem;
    }
    th.label-col {
      background: #f0f0f0;
      width: 140px;
      text-align: left;
    }
    td.label-col {
      font-weight: bold;
      background: #f9f9f9;
      text-align: left;
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sunlight Angle Comparator</h1>
    <p>Compare solar noon elevation and daylight duration across cities</p>
  </header>

  <main>
    <!-- Date Inputs -->
    <div class="date-row">
      <div>
        <label for="dateInput">Select Date:</label>
        <input type="date" id="dateInput" value="2025-06-21">
      </div>
      <div>
        <label for="equivDate">Equivalent Date:</label>
        <input type="text" id="equivDate" readonly value="—">
      </div>
    </div>

    <!-- City Selection -->
    <h2>Select Cities:</h2>
    <div class="city-list" id="cityList"></div>

    <button onclick="compareCities()">Compare</button>

    <!-- City Comparison Table -->
    <div class="table-wrapper">
      <table id="resultsTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Chart -->
    <h2>Daylight Duration Chart</h2>
    <canvas id="daylightChart"></canvas>
  </main>

  <script>
    // Cities (north → south)
    const cityData = {
      "Fairbanks, AK": { lat: 64.8378, lon: -147.7164 },
      "St Andrews, Scotland": { lat: 56.3398, lon: -2.7967 },
      "Hanover, NH": { lat: 43.7022, lon: -72.2896 },
      "East Longmeadow, MA": { lat: 42.0645, lon: -72.5126 },
      "Crozet, VA": { lat: 38.0696, lon: -78.7000 },
      "Nashville, TN": { lat: 36.1627, lon: -86.7816 },
      "Asheville, NC": { lat: 35.5951, lon: -82.5515 },
      "Houston, TX": { lat: 29.7604, lon: -95.3698 },
      "Tampa, FL": { lat: 27.9506, lon: -82.4572 }
    };

    const cityList = document.getElementById("cityList");
    Object.keys(cityData).forEach(city => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${city}"> ${city}`;
      cityList.appendChild(label);
    });

    // --- Math helpers ---
    const toRad = deg => deg * Math.PI / 180;
    const toDeg = rad => rad * 180 / Math.PI;

    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff = date - start + (start.getTimezoneOffset() - date.getTimezoneOffset()) * 60000;
      return Math.floor(diff / 86400000);
    }

    function declination(day) {
      return 23.44 * Math.sin(toRad((360 / 365) * (day - 81)));
    }

    function noonElevation(lat, dec) {
      return 90 - Math.abs(lat - dec);
    }

    function daylightHours(lat, dec) {
      const latR = toRad(lat);
      const decR = toRad(dec);
      const cosH = -Math.tan(latR) * Math.tan(decR);
      if (cosH >= 1) return 0;
      if (cosH <= -1) return 24;
      const H = Math.acos(cosH);
      return (2 * toDeg(H)) / 15;
    }

    function findEquivalentDate(lat, targetHours, refDay, year) {
      let bestDay = null, bestDiff = 999;
      for (let d = 1; d <= 365; d++) {
        if (Math.abs(d - refDay) < 5) continue;
        const h = daylightHours(lat, declination(d));
        const diff = Math.abs(h - targetHours);
        if (diff < 0.1 && diff < bestDiff) {
          bestDiff = diff;
          bestDay = d;
        }
      }
      return bestDay ? new Date(year, 0, bestDay) : null;
    }

    function formatDate(date) {
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    let daylightChart;

    function compareCities() {
      const selected = Array.from(document.querySelectorAll("#cityList input:checked")).map(cb => cb.value);
      if (selected.length === 0) { alert("Select at least one city."); return; }

      const dateVal = document.getElementById("dateInput").value;
      const date = new Date(dateVal);
      const year = date.getFullYear();
      const refDay = dayOfYear(date);

      // Reference city (first checked)
      const refCity = selected[0];
      const refLat = cityData[refCity].lat;
      const refDec = declination(refDay);
      const refHours = daylightHours(refLat, refDec);

      const eqDateObj = findEquivalentDate(refLat, refHours, refDay, year);
      const eqDate = eqDateObj ? formatDate(eqDateObj) : "—";
      document.getElementById("equivDate").value = eqDate;

      buildComparisonTable(selected, refDay);
      plotChart(selected, eqDateObj, refDay);
    }

    function buildComparisonTable(selectedCities, refDay) {
      const tableHead = document.getElementById("tableHead");
      const tableBody = document.getElementById("tableBody");
      tableHead.innerHTML = "";
      tableBody.innerHTML = "";

      // Build header row
      const headRow = document.createElement("tr");
      headRow.innerHTML = `<th class="label-col"></th>` +
        selectedCities.map(city => `<th class="city-col">${city}</th>`).join('');
      tableHead.appendChild(headRow);

      // Row helper
      const makeRow = (label, fn) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td class="label-col">${label}</td>` +
          selectedCities.map(city => `<td>${fn(city)}</td>`).join('');
        tableBody.appendChild(row);
      };

      makeRow("Latitude", city => cityData[city].lat.toFixed(2));
      makeRow("Longitude", city => cityData[city].lon.toFixed(2));
      makeRow("Noon Elev (°)", city => noonElevation(cityData[city].lat, declination(refDay)).toFixed(2));
      makeRow("Daylight (hrs)", city => daylightHours(cityData[city].lat, declination(refDay)).toFixed(2));
    }

    function plotChart(selectedCities, eqDateObj, refDay) {
      const ctx = document.getElementById('daylightChart').getContext('2d');
      const labels = Array.from({ length: 365 }, (_, i) => i + 1);

      const datasets = selectedCities.map(city => {
        const { lat } = cityData[city];
        const data = labels.map(d => daylightHours(lat, declination(d)));
        const color = `hsl(${Math.random() * 360}, 70%, 50%)`;
        return { label: city, data, borderColor: color, fill: false, tension: 0.1 };
      });

      if (daylightChart) daylightChart.destroy();

      const annotations = {
        selectedDate: {
          type: 'line',
          xMin: refDay,
          xMax: refDay,
          borderColor: 'black',
          borderWidth: 2,
          label: { enabled: true, content: 'Selected', position: 'start' }
        }
      };
      if (eqDateObj) {
        annotations.equivalentDate = {
          type: 'line',
          xMin: dayOfYear(eqDateObj),
          xMax: dayOfYear(eqDateObj),
          borderColor: 'red',
          borderWidth: 2,
          label: { enabled: true, content: 'Equivalent', position: 'start' }
        };
      }

      // Month markers (21st of each month)
      const monthDays = [21, 52, 80, 111, 141, 172, 203, 234, 265, 295, 326, 356];
      const monthLabels = ["Jan 21","Feb 21","Mar 21","Apr 21","May 21","Jun 21","Jul 21","Aug 21","Sep 21","Oct 21","Nov 21","Dec 21"];

      daylightChart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: 'Daylight Hours Throughout the Year' },
            annotation: { annotations }
          },
          scales: {
            x: {
              title: { display: true, text: 'Date (21st of each month)' },
              ticks: {
                callback: function(value) {
                  const monthIndex = monthDays.findIndex((d, i) => i < monthDays.length - 1 && value >= d && value < monthDays[i + 1]);
                  return monthIndex >= 0 ? monthLabels[monthIndex] : "";
                },
                maxRotation: 0,
                autoSkip: false
              }
            },
            y: {
              title: { display: true, text: 'Daylight Hours' },
              min: 5, max: 20
            }
          }
        },
        plugins: [Chart.registry.getPlugin('annotation')]
      });
    }
  </script>
</body>
</html>
