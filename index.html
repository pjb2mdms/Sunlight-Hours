<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sunlight Comparator</title>

  <!-- ‚úÖ Chart.js v4 + annotation plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.1"></script>
  <script>
    Chart.register(window['chartjs-plugin-annotation']);
  </script>

  <style>
    :root {
      --blue: #0b5fb3;
      --orange: #f28e2b;
      --text: #222;
      --grid: #eee;
      --red: #e11d48;
    }

    * { box-sizing: border-box; }
    body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; color: var(--text); background: #fff; }

    header {
      background: var(--blue);
      color: #fff;
      text-align: center;
      padding: 1.25rem 0;
    }

    header h1 { margin: 0; font-weight: 700; }

    main {
      max-width: 980px;
      margin: 1.25rem auto 3rem;
      padding: 0 1rem;
    }

    #locationDisplay {
      text-align: center;
      margin-bottom: 0.75rem;
      color: #333;
      font-size: 1rem;
    }

    #locationDisplay span { font-weight: 600; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      justify-content: center;
      align-items: center;
    }

    input[type="date"], input[readonly] {
      font: inherit;
      padding: 0.45rem 0.55rem;
      border: 1px solid #cfd6e1;
      border-radius: 0.5rem;
      min-width: 12rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.1rem 0;
      font-size: 1rem;
    }

    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid #e9eef5;
      text-align: center;
    }

    th.label-col { text-align: left; width: 180px; }

    /* Arc visualization */
    .arc-display {
      text-align: center;
      margin: 1rem auto;
    }

    svg.sun-arc {
      width: 200px;
      height: 120px;
    }

    .arc-path {
      fill: none;
      stroke: var(--blue);
      stroke-width: 4;
      stroke-linecap: round;
    }

    .sun-dot {
      fill: var(--orange);
      stroke: #fff;
      stroke-width: 2;
    }

    .chart-wrap { margin-top: 1.25rem; }
    canvas { width: 100% !important; height: 420px !important; }

    .slider-area { text-align: center; margin-top: 1rem; }
    input[type="range"] {
      width: 100%;
      max-width: 720px;
    }

    .note { font-size: 0.9rem; color: #555; text-align: center; margin-top: 0.35rem; }

    .fade-in { opacity: 0; transition: opacity 0.6s ease-in; }
    .fade-in.show { opacity: 1; }
  </style>
</head>

<body>
  <header><h1>Sunlight Comparator</h1></header>

  <main>
    <div id="locationDisplay">üìç Detecting current location...</div>

    <div class="controls">
      <div>
        <label for="dateInput">Selected Date</label>
        <input type="date" id="dateInput" />
      </div>
      <div>
        <label for="equivDate">Equivalent Date</label>
        <input type="text" id="equivDate" readonly />
      </div>
    </div>

    <div class="live-dates">
      <span id="selectedLabel">Selected: ‚Äî</span>
      <span id="equivLabel">Equivalent: ‚Äî</span>
    </div>

    <table id="resultsTable" class="fade-in">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <!-- üåû Arc display -->
    <div class="arc-display fade-in" id="arcDisplay">
      <svg class="sun-arc" viewBox="0 0 200 120">
        <path class="arc-path" id="arcPath" d="" />
        <circle class="sun-dot" id="sunDot" r="6" cx="100" cy="100" />
      </svg>
      <div id="arcLabel"></div>
    </div>

    <!-- Chart + slider -->
    <div class="chart-wrap fade-in" id="chartContainer">
      <canvas id="daylightChart"></canvas>
      <div class="slider-area">
        <input type="range" id="dateSlider" min="1" max="365" />
        <div class="note">Move the slider to adjust the date.</div>
      </div>
    </div>
  </main>

  <script>
    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;
    const days = Array.from({ length: 365 }, (_, i) => ((i + 354) % 365) + 1);

    function solarDeclination(day) {
      return 23.44 * Math.sin(toRad((360 / 365) * (day - 81)));
    }

    function daylightHours(lat, day) {
      const decR = toRad(solarDeclination(day)), latR = toRad(lat);
      const cosH = -Math.tan(latR) * Math.tan(decR);
      if (cosH >= 1) return 0;
      if (cosH <= -1) return 24;
      const H = Math.acos(cosH);
      return (2 * toDeg(H)) / 15;
    }

    function noonElevation(lat, day) {
      const dec = solarDeclination(day);
      return 90 - Math.abs(lat - dec);
    }

    function dayOfYear(date) {
      const s = new Date(date.getFullYear(), 0, 0);
      return Math.floor((date - s) / 86400000);
    }

    function dateFromDay(year, day) {
      const d = new Date(year, 0);
      d.setDate(day);
      return d;
    }

    function fmtMD(d) {
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function fmtMMDDYYYY(d) {
      return d.toLocaleDateString('en-US');
    }

    function findEquivalentDate(lat, refHrs, refDay, year) {
      let best = null, bestDiff = Infinity;
      for (let d = 1; d <= 365; d++) {
        const diff = Math.abs(daylightHours(lat, d) - refHrs);
        if (Math.abs(d - refDay) < 30) continue;
        if (diff < bestDiff) { bestDiff = diff; best = d; }
      }
      return best ? dateFromDay(year, best) : null;
    }

    /* ---------- Table ---------- */
    function buildTable(lat, lon, refDay) {
      const head = document.getElementById("tableHead"),
            body = document.getElementById("tableBody");
      head.innerHTML = "";
      body.innerHTML = "";
      const addRow = (label, val) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class='label-col'>${label}</td><td>${val}</td>`;
        body.appendChild(tr);
      };
      addRow("Latitude", lat.toFixed(2));
      addRow("Longitude", lon.toFixed(2));
      const elev = noonElevation(lat, refDay);
      addRow("Noon Elevation (¬∞)", elev.toFixed(1));
      addRow("Daylight (hrs)", daylightHours(lat, refDay).toFixed(2));
    }

    /* ---------- Arc Display ---------- */
    function updateArcDisplay(elev) {
      const r = 80;
      const startX = 100 - r, endX = 100 + r, baseY = 100;
      const elevRad = toRad(elev);
      const h = Math.sin(elevRad) * r;
      const sunX = 100, sunY = baseY - h;

      // semicircle arc
      const path = `M ${startX} ${baseY} A ${r} ${r} 0 0 1 ${endX} ${baseY}`;
      document.getElementById("arcPath").setAttribute("d", path);
      document.getElementById("sunDot").setAttribute("cx", sunX);
      document.getElementById("sunDot").setAttribute("cy", sunY);
      document.getElementById("arcLabel").textContent = `Noon Elevation: ${elev.toFixed(1)}¬∞`;
      document.getElementById("arcDisplay").classList.add("show");
    }

    /* ---------- Chart ---------- */
    let chart;
    function createChart(lat) {
      const ctx = document.getElementById("daylightChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: days,
          datasets: [{
            label: "Noon Elevation (¬∞)",
            data: days.map(d => noonElevation(lat, d)),
            borderColor: "#0b5fb3",
            borderWidth: 2,
            fill: false,
            tension: 0.25,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            annotation: { annotations: {} }
          },
          scales: {
            x: { display: false, min: 1, max: 365 },
            y: { title: { display: true, text: "Noon Sun Elevation (¬∞)" }, min: 0, max: 90 }
          }
        }
      });
    }

    function updateAnnotations(refDay, eqDateObj) {
      if (!chart) return;
      const year = new Date(document.getElementById("dateInput").value).getFullYear();
      const selDate = dateFromDay(year, refDay);
      const annotations = {
        selected: {
          type: "line",
          xMin: refDay,
          xMax: refDay,
          borderColor: "#000",
          borderWidth: 2,
          label: { enabled: true, content: fmtMD(selDate), position: "start", backgroundColor: "rgba(255,255,255,.8)", color: "#000" }
        }
      };
      if (eqDateObj) {
        const eqDay = dayOfYear(eqDateObj);
        annotations.equivalent = {
          type: "line",
          xMin: eqDay,
          xMax: eqDay,
          borderColor: "#e11d48",
          borderWidth: 2,
          label: { enabled: true, content: fmtMD(eqDateObj), position: "start", backgroundColor: "rgba(255,255,255,.85)", color: "#e11d48" }
        };
      }
      chart.options.plugins.annotation.annotations = annotations;
      chart.update();
    }

    /* ---------- Interaction ---------- */
    const dateInput = document.getElementById("dateInput"),
          equivEl = document.getElementById("equivDate"),
          slider = document.getElementById("dateSlider"),
          selectedLbl = document.getElementById("selectedLabel"),
          equivLbl = document.getElementById("equivLabel");

    let userLat = 27.95, userLon = -82.46; // fallback

    function updateAll() {
      const d = new Date(dateInput.value);
      const refDay = dayOfYear(d);
      const year = d.getFullYear();
      const refHrs = daylightHours(userLat, refDay);
      const eqDate = findEquivalentDate(userLat, refHrs, refDay, year);
      const elev = noonElevation(userLat, refDay);

      equivEl.value = eqDate ? fmtMMDDYYYY(eqDate) : "‚Äî";
      selectedLbl.textContent = `Selected: ${fmtMD(d)}`;
      equivLbl.textContent = `Equivalent: ${eqDate ? fmtMD(eqDate) : "‚Äî"}`;
      buildTable(userLat, userLon, refDay);
      updateAnnotations(refDay, eqDate);
      updateArcDisplay(elev);

      document.getElementById("resultsTable").classList.add("show");
      document.getElementById("chartContainer").classList.add("show");
    }

    slider.addEventListener("input", () => {
      const d = new Date(dateInput.value);
      const y = d.getFullYear();
      const newD = dateFromDay(y, Number(slider.value));
      dateInput.value = newD.toISOString().slice(0, 10);
      updateAll();
    });

    dateInput.addEventListener("change", updateAll);

    /* ---------- Init ---------- */
    async function init() {
      const locDisplay = document.getElementById("locationDisplay");
      const today = new Date();
      dateInput.value = today.toISOString().split("T")[0];

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          userLat = pos.coords.latitude; userLon = pos.coords.longitude;
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLon}&format=json`);
            const data = await res.json();
            const display = data.address.city || data.address.town || data.address.state || "Your area";
            locDisplay.innerHTML = `üìç Location: <span>${display}</span> (${userLat.toFixed(2)}¬∞ N, ${Math.abs(userLon).toFixed(2)}¬∞ ${userLon < 0 ? 'W' : 'E'})`;
          } catch {
            locDisplay.innerHTML = "üìç Location detected";
          }
          createChart(userLat);
          updateAll();
        }, () => {
          locDisplay.innerHTML = "üìç Using default location: <span>Tampa, FL</span> (27.95¬∞ N, 82.46¬∞ W)";
          createChart(userLat);
          updateAll();
        });
      } else {
        locDisplay.innerHTML = "üìç Using default location: <span>Tampa, FL</span> (27.95¬∞ N, 82.46¬∞ W)";
        createChart(userLat);
        updateAll();
      }
    }

    init();
  </script>
</body>
</html>
