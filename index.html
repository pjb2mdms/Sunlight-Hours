<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sunlight Comparator</title>
  <style>
    :root {
      --blue: #0b5fb3;
      --orange: #f28e2b;
      --text: #222;
      --bg: #fff;
      --border: #d9e2ef;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 0;
    }

    header {
      background: var(--blue);
      color: #fff;
      text-align: center;
      padding: 1.25rem 0;
    }

    main {
      max-width: 700px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    #location {
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 1.2rem;
    }

    #location span {
      font-weight: bold;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }

    label {
      font-weight: 600;
      margin-right: 0.4rem;
    }

    input[type="date"], input[readonly] {
      padding: 0.45rem 0.6rem;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 0.4rem;
      min-width: 11rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 0.6rem 0.4rem;
      text-align: center;
    }

    th.label-col {
      text-align: left;
      width: 180px;
    }

    #status {
      text-align: center;
      color: #777;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <header><h1>Sunlight Comparator</h1></header>

  <main>
    <div id="location">📍 Detecting location...</div>

    <div class="controls">
      <div>
        <label for="dateInput">Selected Date</label>
        <input type="date" id="dateInput" />
      </div>
      <div>
        <label for="equivDate">Equivalent Date</label>
        <input type="text" id="equivDate" readonly />
      </div>
    </div>

    <table>
      <tbody>
        <tr><th class="label-col">Latitude (°)</th><td id="latVal">—</td></tr>
        <tr><th class="label-col">Longitude (°)</th><td id="lonVal">—</td></tr>
        <tr><th class="label-col">Sunrise (local)</th><td id="sunrise">—</td></tr>
        <tr><th class="label-col">Sunset (local)</th><td id="sunset">—</td></tr>
        <tr><th class="label-col">Daylight Hours</th><td id="daylightHrs">—</td></tr>
        <tr><th class="label-col">Noon Elevation (°)</th><td id="elevation">—</td></tr>
      </tbody>
    </table>

    <div id="status"></div>
  </main>

  <script>
    /* ---------- Math utilities ---------- */
    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;

    function solarDeclination(day) {
      return 23.44 * Math.sin(toRad((360 / 365) * (day - 81)));
    }

    function equationOfTime(day) {
      const B = toRad((360 / 365) * (day - 81));
      return 9.87 * Math.sin(2 * B) - 7.53 * Math.cos(B) - 1.5 * Math.sin(B);
    }

    function daylightHours(lat, day) {
      const dec = toRad(solarDeclination(day));
      const latR = toRad(lat);
      const cosH = -Math.tan(latR) * Math.tan(dec);
      if (cosH >= 1) return 0;
      if (cosH <= -1) return 24;
      const H = Math.acos(cosH);
      return (2 * toDeg(H)) / 15;
    }

    function noonElevation(lat, day) {
      const dec = solarDeclination(day);
      return 90 - Math.abs(lat - dec);
    }

    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      return Math.floor((date - start) / 86400000);
    }

    function dateFromDay(year, day) {
      const d = new Date(year, 0);
      d.setDate(day);
      return d;
    }

    function findEquivalentDate(lat, targetElev, refDay, year) {
      let best = null;
      let smallestDiff = Infinity;
      for (let d = 1; d <= 365; d++) {
        const elev = noonElevation(lat, d);
        const diff = Math.abs(elev - targetElev);
        if (Math.abs(d - refDay) < 30) continue;
        if (diff < smallestDiff) {
          smallestDiff = diff;
          best = d;
        }
      }
      return best ? dateFromDay(year, best) : null;
    }

    function fmtDate(d) {
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    /* ---------- Sunrise / Sunset ---------- */
    function sunriseSunset(lat, lon, day, dateForTZ) {
      const dec = toRad(solarDeclination(day));
      const latR = toRad(lat);
      const solarDep = toRad(-0.83);
      const cosH = (Math.sin(solarDep) - Math.sin(latR) * Math.sin(dec)) / (Math.cos(latR) * Math.cos(dec));

      if (cosH > 1) return { sunrise: '—', sunset: '—', note: 'No sunrise (polar night)' };
      if (cosH < -1) return { sunrise: '—', sunset: '—', note: 'Sun above horizon all day' };

      const H = Math.acos(cosH);
      const Hhours = toDeg(H) / 15;
      const tzOffsetMin = -dateForTZ.getTimezoneOffset();
      const tzHours = tzOffsetMin / 60;
      const tzMeridian = 15 * Math.round(tzHours);
      const EoT = equationOfTime(day);
      const solarNoon = 12 - (lon - tzMeridian) / 15 - EoT / 60;
      const sunriseLocalHours = solarNoon - Hhours;
      const sunsetLocalHours = solarNoon + Hhours;
      return {
        sunrise: formatHours(sunriseLocalHours),
        sunset: formatHours(sunsetLocalHours)
      };
    }

    function formatHours(hours) {
      const hNorm = (hours + 24) % 24;
      const h = Math.floor(hNorm);
      const m = Math.round((hNorm - h) * 60);
      const displayH = ((h + 11) % 12) + 1;
      const ampm = h >= 12 ? 'PM' : 'AM';
      return `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
    }

    /* ---------- DOM + logic ---------- */
    const dateInput = document.getElementById('dateInput');
    const equivField = document.getElementById('equivDate');
    const daylightEl = document.getElementById('daylightHrs');
    const elevEl = document.getElementById('elevation');
    const locationEl = document.getElementById('location');
    const statusEl = document.getElementById('status');

    let userLat = 27.95;
    let userLon = -82.46;

    function updateValues() {
      const d = new Date(dateInput.value + "T00:00");
      const year = d.getFullYear();
      const dayNum = dayOfYear(d);
      const elev = noonElevation(userLat, dayNum);
      const hrs = daylightHours(userLat, dayNum);
      const eqDate = findEquivalentDate(userLat, elev, dayNum, year);
      const times = sunriseSunset(userLat, userLon, dayNum, d);

      daylightEl.textContent = hrs.toFixed(2);
      elevEl.textContent = elev.toFixed(2);
      equivField.value = eqDate ? fmtDate(eqDate) : '—';
      document.getElementById('latVal').textContent = userLat.toFixed(2);
      document.getElementById('lonVal').textContent = userLon.toFixed(2);
      document.getElementById('sunrise').textContent = times.sunrise;
      document.getElementById('sunset').textContent = times.sunset;
    }

    dateInput.addEventListener('change', updateValues);

    function init() {
      const today = new Date();
      dateInput.value = today.toLocaleDateString('en-CA'); // local date, not UTC

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async pos => {
          userLat = pos.coords.latitude;
          userLon = pos.coords.longitude;
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLon}&format=json`);
            const data = await res.json();
            const name = data.address.city || data.address.town || data.address.village || data.address.state || 'your area';
            locationEl.innerHTML = `📍 Location: <span>${name}</span> (${userLat.toFixed(2)}° N, ${Math.abs(userLon).toFixed(2)}° ${userLon < 0 ? 'W' : 'E'})`;
          } catch {
            locationEl.innerHTML = `📍 Coordinates: ${userLat.toFixed(2)}°, ${userLon.toFixed(2)}°`;
          }
          updateValues();
        }, () => {
          locationEl.innerHTML = "📍 Using default location: <span>Tampa, FL</span> (27.95° N, 82.46° W)";
          updateValues();
        });
      } else {
        locationEl.innerHTML = "📍 Using default location: <span>Tampa, FL</span> (27.95° N, 82.46° W)";
        updateValues();
      }
    }

    init();
  </script>
</body>
</html>
