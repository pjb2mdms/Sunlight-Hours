<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Sunlight Comparator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
:root{--blue:#0b5fb3;--orange:#f28e2b;--text:#222;--bg:#f8fafc;--card:#fff;}
body{font-family:"Helvetica Neue",Arial,sans-serif;margin:0;color:var(--text);background:var(--bg);}
header{background:linear-gradient(135deg,#0b5fb3 0%,#084a8f 100%);color:#fff;text-align:center;padding:2rem 1rem;box-shadow:0 2px 8px rgba(0,0,0,.1);}
header h1{margin:0;font-size:2.2rem;font-weight:300;letter-spacing:.5px;}
header p{margin:.5rem 0 0;opacity:.9;font-size:1rem;}
main{max-width:1100px;margin:2rem auto 3rem;padding:0 1rem;}
.card{background:var(--card);border-radius:12px;padding:1.5rem;margin:1.5rem 0;box-shadow:0 1px 3px rgba(0,0,0,.08);}
.city-selectors{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;}
@media(max-width:768px){.city-selectors{grid-template-columns:1fr;}}
.selector-group{display:flex;flex-direction:column;gap:.5rem;}
.selector-group label{font-weight:600;font-size:.95rem;color:#555;display:flex;align-items:center;gap:.5rem;}
.selector-group select{font:inherit;font-size:1rem;padding:.7rem;border:2px solid #e2e8f0;border-radius:8px;background:#fff;transition:all .2s;}
.selector-group select:hover{border-color:#cbd5e1;}
.selector-group select:focus{outline:none;border-color:var(--blue);box-shadow:0 0 0 3px rgba(11,95,179,.1);}

.date-earth-section{display:grid;grid-template-columns:160px 1fr;gap:1.5rem;align-items:center;margin-bottom:1.5rem;padding:1.2rem;background:#f8fafc;border-radius:8px;}
@media(max-width:768px){.date-earth-section{grid-template-columns:1fr;}}
.earth-container{position:relative;width:160px;height:160px;margin:0 auto;}
.earth-canvas{width:100%;height:100%;border-radius:50%;box-shadow:0 4px 12px rgba(0,0,0,.15);}
.slider-controls{flex:1;}
.live-dates{font-weight:600;margin-bottom:1rem;display:flex;justify-content:center;gap:1rem;flex-wrap:wrap;align-items:center;}
.live-dates span{display:inline-block;padding:.5rem 1rem;background:#fff;border-radius:6px;box-shadow:0 1px 2px rgba(0,0,0,.05);}
.date-label{font-size:.85rem;color:#666;display:block;}
.date-value{font-size:1.1rem;color:#000;}
.date-selected{border:2px solid #1e293b;}
.date-equiv{border:2px solid #e11d48;}
input[type="range"]{-webkit-appearance:none;appearance:none;width:100%;max-width:800px;height:8px;background:linear-gradient(to right,#e2e8f0 0%,#cbd5e1 100%);border-radius:4px;outline:none;margin:1rem 0;}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--blue);border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.2);cursor:pointer;transition:all .2s;}
input[type="range"]::-webkit-slider-thumb:hover{transform:scale(1.1);}
input[type="range"]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--blue);border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,.2);cursor:pointer;}
.note{font-size:.85rem;color:#666;margin-top:.5rem;text-align:center;}

.chart-section{display:grid;grid-template-columns:auto 1fr auto;gap:1.5rem;align-items:start;}
@media(max-width:968px){.chart-section{grid-template-columns:1fr;}}

.vertical-tabs{display:flex;flex-direction:column;gap:.5rem;padding-top:2rem;}
@media(max-width:968px){.vertical-tabs{flex-direction:row;padding-top:0;justify-content:center;margin-bottom:1rem;}}
.vertical-tabs button{font:inherit;font-weight:600;padding:.7rem 1rem;border-radius:8px;border:2px solid #e2e8f0;cursor:pointer;background:#fff;color:#333;transition:all .2s;white-space:nowrap;min-width:140px;}
@media(max-width:968px){.vertical-tabs button{min-width:auto;}}
.vertical-tabs button:hover{background:#f8fafc;}
.vertical-tabs button.active{background:var(--blue);color:#fff;border-color:var(--blue);}

.chart-and-table{flex:1;min-width:0;}
.chart-container{position:relative;height:400px;margin-bottom:1.5rem;}

.data-table-section{min-width:280px;}
@media(max-width:968px){.data-table-section{min-width:0;}}
table{width:100%;border-collapse:collapse;font-size:.9rem;}
th,td{padding:.7rem .5rem;border-bottom:1px solid #e9eef5;text-align:left;}
th{background:#f8fafc;font-weight:600;color:#555;font-size:.85rem;}
td:first-child{font-weight:500;color:#666;}
td:last-child{text-align:right;}
td svg{width:60px;height:35px;vertical-align:middle;margin-left:auto;display:block;}
.city-header{background:#f1f5f9;font-weight:700;color:#334155;text-align:center;padding:.6rem;}

.icon{display:inline-block;width:18px;height:18px;vertical-align:middle;}
</style>
</head>
<body>
<header>
<h1>‚òÄÔ∏è Sunlight Comparator</h1>
<p>Compare daylight hours and sun elevation between any two cities</p>
</header>
<main>
<div class="card">
<div class="city-selectors">
<div class="selector-group">
<label><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>Reference City</label>
<select id="referenceCity"></select>
</div>
<div class="selector-group">
<label><svg class="icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>Comparison City</label>
<select id="compareCity"></select>
</div>
</div>
</div>

<div class="card">
<div class="date-earth-section">
<div class="earth-container">
<canvas id="earthCanvas" class="earth-canvas" width="320" height="320"></canvas>
</div>
<div class="slider-controls">
<div class="live-dates">
<span class="date-selected"><span class="date-label">Selected Date</span><span class="date-value" id="selectedLabel">‚Äî</span></span>
<span class="date-equiv"><span class="date-label">Equivalent Date</span><span class="date-value" id="equivLabel">‚Äî</span></span>
</div>
<input type="range" id="dateSlider" min="1" max="365" step="1" value="172">
<div class="note">üí° Drag the slider to explore different dates throughout the year</div>
</div>
</div>

<div class="chart-section">
<div class="vertical-tabs">
<button id="hoursBtn" class="active">üìä Daylight<br>Hours</button>
<button id="elevBtn">üåû Noon<br>Elevation</button>
</div>
<div class="chart-and-table">
<div class="chart-container"><canvas id="chartCanvas"></canvas></div>
</div>
<div class="data-table-section">
<table id="resultsTable">
<tbody id="tableBody"></tbody>
</table>
</div>
</div>
</div>
</main>
<script>
const cities=[
{lat:52.37,lon:4.89,tz:"Europe/Amsterdam",name:"Amsterdam",country:"Netherlands"},
{lat:47.50,lon:19.04,tz:"Europe/Budapest",name:"Budapest",country:"Hungary"},
{lat:50.85,lon:4.35,tz:"Europe/Brussels",name:"Brussels",country:"Belgium"},
{lat:-34.60,lon:-58.38,tz:"America/Argentina/Buenos_Aires",name:"Buenos Aires",country:"Argentina"},
{lat:35.23,lon:-80.84,tz:"America/New_York",name:"Charlotte, NC",country:"USA"},
{lat:64.13,lon:-21.82,tz:"Atlantic/Reykjavik",name:"Reykjavik",country:"Iceland"},
{lat:55.68,lon:12.57,tz:"Europe/Copenhagen",name:"Copenhagen",country:"Denmark"},
{lat:53.35,lon:-6.26,tz:"Europe/Dublin",name:"Dublin",country:"Ireland"},
{lat:60.17,lon:24.94,tz:"Europe/Helsinki",name:"Helsinki",country:"Finland"},
{lat:29.76,lon:-95.37,tz:"America/Chicago",name:"Houston, TX",country:"USA"},
{lat:51.51,lon:-0.13,tz:"Europe/London",name:"London",country:"UK"},
{lat:40.42,lon:-3.70,tz:"Europe/Madrid",name:"Madrid",country:"Spain"},
{lat:19.43,lon:-99.13,tz:"America/Mexico_City",name:"Mexico City",country:"Mexico"},
{lat:59.91,lon:10.75,tz:"Europe/Oslo",name:"Oslo",country:"Norway"},
{lat:45.42,lon:-75.70,tz:"America/Toronto",name:"Ottawa",country:"Canada"},
{lat:9.10,lon:-79.38,tz:"America/Panama",name:"Panama City",country:"Panama"},
{lat:48.85,lon:2.35,tz:"Europe/Paris",name:"Paris",country:"France"},
{lat:33.45,lon:-112.07,tz:"America/Phoenix",name:"Phoenix, AZ",country:"USA"},
{lat:50.08,lon:14.44,tz:"Europe/Prague",name:"Prague",country:"Czech Republic"},
{lat:41.90,lon:12.50,tz:"Europe/Rome",name:"Rome",country:"Italy"},
{lat:-33.45,lon:-70.67,tz:"America/Santiago",name:"Santiago",country:"Chile"},
{lat:56.34,lon:-2.80,tz:"Europe/London",name:"St Andrews",country:"Scotland"},
{lat:59.33,lon:18.06,tz:"Europe/Stockholm",name:"Stockholm",country:"Sweden"},
{lat:27.95,lon:-82.46,tz:"America/New_York",name:"Tampa, FL",country:"USA"},
{lat:38.91,lon:-77.04,tz:"America/New_York",name:"Washington, D.C.",country:"USA"}
];

const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;

function solarDeclination(day){
return 23.44*Math.sin(toRad((360/365)*(day-81)));
}

function daylightHours(lat,day){
const decR=toRad(solarDeclination(day)),latR=toRad(lat);
const cosH=-Math.tan(latR)*Math.tan(decR);
if(cosH>=1)return 0;
if(cosH<=-1)return 24;
const H=Math.acos(cosH);
return(2*toDeg(H))/15;
}

function noonElevation(lat,day){
const dec=solarDeclination(day);
return 90-Math.abs(lat-dec);
}

function dayOfYear(dt){
return Math.floor((dt-new Date(dt.getFullYear(),0,0))/86400000);
}

function dateFromDay(y,d){
return new Date(y,0,d);
}

function fmtMD(date){
return date.toLocaleDateString("en-US",{month:"short",day:"numeric"}).replace(',','');
}

function findEquivalentDate(lat,targetHours,refDay,year){
const summerSolstice=172;
const winterSolstice=355;
const distToSummer=Math.abs(refDay-summerSolstice);
const distToWinter=Math.min(Math.abs(refDay-winterSolstice),Math.abs(refDay-(winterSolstice-365)));
const closestSolstice=distToSummer<distToWinter?summerSolstice:winterSolstice;
const mirrorDay=2*closestSolstice-refDay;
let normalizedMirror=mirrorDay;
if(normalizedMirror<1)normalizedMirror+=365;
if(normalizedMirror>365)normalizedMirror-=365;
return dateFromDay(year,normalizedMirror);
}

function findEquivalentAngleDate(lat,targetElev,refDay,year){
let best=null,bestDiff=1e9;
for(let d=1;d<=365;d++){
if(d===refDay)continue;
const elev=noonElevation(lat,d);
const diff=Math.abs(elev-targetElev);
if(diff<bestDiff){
bestDiff=diff;
best=d;
}
}
return best?dateFromDay(year,best):null;
}

function fmtHoursMin(h){
const hrs=Math.floor(h);
const mins=Math.round((h-hrs)*60);
return `${hrs}h ${mins.toString().padStart(2,'0')}m`;
}

function getTimeZoneAbbr(tz){
try{
const fmt=new Intl.DateTimeFormat('en-US',{timeZone:tz,timeZoneName:'short'});
return fmt.formatToParts(new Date()).find(p=>p.type==='timeZoneName').value;
}catch{
return'';
}
}

function getTimes(lat,lon,day,tz){
const dec=toRad(solarDeclination(day)),latR=toRad(lat),solarDep=toRad(-0.83);
const cosH=(Math.sin(solarDep)-Math.sin(latR)*Math.sin(dec))/(Math.cos(latR)*Math.cos(dec));
if(cosH>1||cosH<-1)return{sunrise:'‚Äî',sunset:'‚Äî',hrs:0};
const H=Math.acos(cosH);
const Hh=toDeg(H)/15;
const daylight=2*Hh;
const year=new Date().getFullYear();
const dateObj=new Date(year,0,day);
const month=dateObj.getMonth();
const dayOfMonth=dateObj.getDate();
const solarNoon=12-(lon/15);
const sunriseUTC=solarNoon-Hh;
const sunsetUTC=solarNoon+Hh;
const fmtTime=(utcHr)=>{
const hrs=Math.floor(utcHr);
const mins=Math.round((utcHr-hrs)*60);
const d=new Date(Date.UTC(year,month,dayOfMonth,hrs,mins,0));
return d.toLocaleTimeString('en-US',{timeZone:tz,hour:'numeric',minute:'2-digit'});
};
return{sunrise:fmtTime(sunriseUTC),sunset:fmtTime(sunsetUTC),hrs:daylight};
}

function arcSVG(lat,day,color){
const elev=noonElevation(lat,day);
const R=28,a=Math.min(90,Math.max(0,elev))*Math.PI/180;
const x=26+R*Math.cos(Math.PI-a),y=30-R*Math.sin(Math.PI-a);
return `<svg viewBox='0 0 60 36' style='display:block;margin:0 auto;'><path d='M4 30 A28 28 0 0 1 56 30' stroke='#c9d3e3' stroke-width='1.2' fill='none'/><line x1='26' y1='30' x2='${x.toFixed(1)}' y2='${y.toFixed(1)}' stroke='${color}' stroke-width='2.5'/><circle cx='${x.toFixed(1)}' cy='${y.toFixed(1)}' r='3.5' fill='${color}'/></svg>`;
}

function buildTable(base,comp,day,mode){
const body=document.getElementById('tableBody');
body.innerHTML='';
const tb1=getTimes(base.lat,base.lon,day,base.tz),tb2=getTimes(comp.lat,comp.lon,day,comp.tz);
const ab1=getTimeZoneAbbr(base.tz),ab2=getTimeZoneAbbr(comp.tz);
const refElev=noonElevation(base.lat,day);
const compElev=noonElevation(comp.lat,day);
const angleDate=findEquivalentAngleDate(comp.lat,refElev,day,new Date().getFullYear());

if(mode==='hours'){
const rows=[
{label:'',value:`<div class="city-header">${base.name}</div>`,span:true},
{label:'Latitude',value:base.lat.toFixed(2)+'¬∞'},
{label:'Sunrise',value:`${tb1.sunrise} ${ab1}`},
{label:'Sunset',value:`${tb1.sunset} ${ab1}`},
{label:'Daylight',value:fmtHoursMin(tb1.hrs)},
{label:'',value:`<div class="city-header">${comp.name}</div>`,span:true},
{label:'Latitude',value:comp.lat.toFixed(2)+'¬∞'},
{label:'Sunrise',value:`${tb2.sunrise} ${ab2}`},
{label:'Sunset',value:`${tb2.sunset} ${ab2}`},
{label:'Daylight',value:fmtHoursMin(tb2.hrs)}
];
rows.forEach(r=>{
const tr=document.createElement('tr');
if(r.span){
tr.innerHTML=`<td colspan="2">${r.value}</td>`;
}else{
tr.innerHTML=`<td>${r.label}</td><td>${r.value}</td>`;
}
body.appendChild(tr);
});
}else{
const rows=[
{label:'',value:`<div class="city-header">${base.name}</div>`,span:true},
{label:'Latitude',value:base.lat.toFixed(2)+'¬∞'},
{label:'Noon Elevation',value:`${refElev.toFixed(1)}¬∞`},
{label:'',value:arcSVG(base.lat,day,'#0b5fb3'),span:true},
{label:'',value:`<div class="city-header">${comp.name}</div>`,span:true},
{label:'Latitude',value:comp.lat.toFixed(2)+'¬∞'},
{label:'Noon Elevation',value:`${compElev.toFixed(1)}¬∞`},
{label:'',value:arcSVG(comp.lat,day,'#f28e2b'),span:true},
{label:'',value:'<div style="height:8px"></div>',span:true},
{label:'Equivalent Angle',value:angleDate?`${refElev.toFixed(1)}¬∞ on ${fmtMD(angleDate)}`:'‚Äî',span:true}
];
rows.forEach(r=>{
const tr=document.createElement('tr');
if(r.span){
tr.innerHTML=`<td colspan="2">${r.value}</td>`;
}else{
tr.innerHTML=`<td>${r.label}</td><td>${r.value}</td>`;
}
body.appendChild(tr);
});
}
}

let chart,mode='hours',chartData=null;

function prepareChartData(base,comp){
const daysRaw=[];
for(let d=355;d<=365;d++)daysRaw.push(d);
for(let d=1;d<=356;d++)daysRaw.push(d);
const days=Array.from({length:daysRaw.length},(_,i)=>i+1);
const dataHours={
base:daysRaw.map(d=>daylightHours(base.lat,d)),
comp:daysRaw.map(d=>daylightHours(comp.lat,d))
};
const dataElev={
base:daysRaw.map(d=>noonElevation(base.lat,d)),
comp:daysRaw.map(d=>noonElevation(comp.lat,d)),
threshold:noonElevation(base.lat,355)
};
return{days,daysRaw,dataHours,dataElev,base,comp};
}

function drawChart(refDay,eqDate,angleDate,refElev){
if(!chartData)return;
const ctx=document.getElementById("chartCanvas").getContext("2d");
const {days,daysRaw,dataHours,dataElev,base,comp}=chartData;
const isHours=mode==="hours";
const data=isHours?dataHours:dataElev;
const lbl=isHours?"Daylight Hours":"Noon Elevation (¬∞)";
const yCfg=isHours?{min:5,max:20}:{min:0,max:90};
const dsBase={
label:base.name,
data:data.base,
borderColor:"#0b5fb3",
borderWidth:2.5,
tension:.3,
fill:false,
pointRadius:0
};
const dsComp={
label:comp.name,
data:data.comp,
borderColor:"#f28e2b",
borderWidth:2.5,
tension:.3,
fill:false,
pointRadius:0
};
const datasets=[dsBase,dsComp];
const annotations={};
if(!isHours){
const threshold=dataElev.threshold;
annotations.threshold={
type:"line",
yMin:threshold,
yMax:threshold,
borderColor:"rgba(11,95,179,0.4)",
borderWidth:2,
borderDash:[5,5],
label:{
enabled:true,
content:`${base.name} Dec 21: ${threshold.toFixed(1)}¬∞`,
position:"end",
backgroundColor:"rgba(255,255,255,.9)",
color:"#0b5fb3",
font:{size:11}
}
};
const below=daysRaw.map(d=>dataElev.comp[daysRaw.indexOf(d)]<threshold?threshold:null);
const shade={
label:`Below ${base.name} Dec 21`,
data:below,
backgroundColor:"rgba(11,95,179,0.12)",
borderWidth:0,
type:"line",
pointRadius:0,
fill:true
};
datasets.splice(1,0,shade);
if(refElev!==undefined){
annotations.angleHorizontal={
type:"line",
yMin:refElev,
yMax:refElev,
borderColor:"#10b981",
borderWidth:2.5,
borderDash:[5,5],
label:{
enabled:true,
content:`${base.name} angle: ${refElev.toFixed(1)}¬∞`,
position:"start",
backgroundColor:"rgba(255,255,255,.95)",
color:"#10b981",
font:{size:11,weight:"bold"}
}
};
}
}
const refIdx=daysRaw.indexOf(refDay);
if(refIdx!==-1){
annotations.selected={
type:"line",
xMin:refIdx+1,
xMax:refIdx+1,
borderColor:"#1e293b",
borderWidth:2.5,
label:{
enabled:true,
content:fmtMD(dateFromDay(new Date().getFullYear(),refDay)),
position:"start",
backgroundColor:"rgba(255,255,255,.95)",
color:"#1e293b",
font:{size:11,weight:"bold"}
}
};
}
if(eqDate){
const eqD=dayOfYear(eqDate);
const eqIdx=daysRaw.indexOf(eqD);
if(eqIdx!==-1){
annotations.equiv={
type:"line",
xMin:eqIdx+1,
xMax:eqIdx+1,
borderColor:"#e11d48",
borderWidth:2.5,
label:{
enabled:true,
content:fmtMD(eqDate),
position:"start",
backgroundColor:"rgba(255,255,255,.95)",
color:"#e11d48",
font:{size:11,weight:"bold"}
}
};
}
}
if(chart)chart.destroy();
chart=new Chart(ctx,{
type:"line",
data:{labels:days,datasets},
options:{
responsive:true,
maintainAspectRatio:false,
animation:false,
plugins:{
legend:{
display:true,
position:"bottom",
labels:{
usePointStyle:true,
padding:15,
font:{size:12}
}
},
annotation:{annotations}
},
scales:{
x:{display:false},
y:{
title:{
display:true,
text:lbl,
font:{size:13,weight:"600"}
},
...yCfg,
grid:{color:"#e2e8f0"}
}
}
},
plugins:[Chart.registry.getPlugin("annotation")]
});
}

function updateAll(){
const refIdx=document.getElementById("referenceCity").selectedIndex;
const compIdx=document.getElementById("compareCity").selectedIndex;
const base=cities[refIdx];
const comp=cities[compIdx];
const sliderVal=Number(document.getElementById("dateSlider").value);
const date=dateFromDay(new Date().getFullYear(),sliderVal);
const day=sliderVal;
const eqDate=findEquivalentDate(comp.lat,daylightHours(base.lat,day),day,date.getFullYear());
const refElev=noonElevation(base.lat,day);
const angleDate=findEquivalentAngleDate(comp.lat,refElev,day,date.getFullYear());
document.getElementById("selectedLabel").textContent=fmtMD(date);
document.getElementById("equivLabel").textContent=eqDate?fmtMD(eqDate):"‚Äî";
buildTable(base,comp,day,mode);
chartData=prepareChartData(base,comp);
drawChart(day,eqDate,angleDate,refElev);
drawEarth(day);
}

function updateAnnotationsOnly(){
const refIdx=document.getElementById("referenceCity").selectedIndex;
const compIdx=document.getElementById("compareCity").selectedIndex;
const base=cities[refIdx];
const comp=cities[compIdx];
const sliderVal=Number(document.getElementById("dateSlider").value);
const date=dateFromDay(new Date().getFullYear(),sliderVal);
const day=sliderVal;
const eqDate=findEquivalentDate(comp.lat,daylightHours(base.lat,day),day,date.getFullYear());
const refElev=noonElevation(base.lat,day);
const angleDate=findEquivalentAngleDate(comp.lat,refElev,day,date.getFullYear());
document.getElementById("selectedLabel").textContent=fmtMD(date);
document.getElementById("equivLabel").textContent=eqDate?fmtMD(eqDate):"‚Äî";
buildTable(base,comp,day,mode);
drawChart(day,eqDate,angleDate,refElev);
drawEarth(day);
}

function drawEarth(day){
const canvas=document.getElementById('earthCanvas');
const ctx=canvas.getContext('2d');
const w=canvas.width;
const h=canvas.height;
const cx=w/2;
const cy=h/2;
const radius=w*0.45;

// Tampa FL coordinates for geosynchronous view
const tampaLat=27.95;
const tampaLon=-82.46;

ctx.clearRect(0,0,w,h);

// Draw space background
const spaceGrad=ctx.createRadialGradient(cx,cy,0,cx,cy,w*0.7);
spaceGrad.addColorStop(0,'#001a33');
spaceGrad.addColorStop(1,'#000000');
ctx.fillStyle=spaceGrad;
ctx.fillRect(0,0,w,h);

// Add stars
ctx.fillStyle='#ffffff';
for(let i=0;i<80;i++){
const sx=Math.random()*w;
const sy=Math.random()*h;
const sr=Math.random()*1.5;
ctx.beginPath();
ctx.arc(sx,sy,sr,0,Math.PI*2);
ctx.fill();
}

// Calculate solar declination
const declination=solarDeclination(day);
const decRad=toRad(declination);

// Draw Earth sphere with realistic ocean gradient
const earthGrad=ctx.createRadialGradient(cx-radius*0.3,cy-radius*0.3,radius*0.1,cx,cy,radius);
earthGrad.addColorStop(0,'#7cb9e8');
earthGrad.addColorStop(0.3,'#4a90c8');
earthGrad.addColorStop(0.6,'#2a5f8f');
earthGrad.addColorStop(0.85,'#1a3f5f');
earthGrad.addColorStop(1,'#0d1f2f');
ctx.fillStyle=earthGrad;
ctx.beginPath();
ctx.arc(cx,cy,radius,0,Math.PI*2);
ctx.fill();

// Draw landmasses (simplified continents visible from Tampa perspective)
ctx.save();
ctx.beginPath();
ctx.arc(cx,cy,radius,0,Math.PI*2);
ctx.clip();

// Function to convert lat/lon to x/y on canvas from Tampa's perspective
function latLonToXY(lat,lon){
// Orthographic projection centered on Tampa
const latR=toRad(lat);
const lonR=toRad(lon);
const tampaLatR=toRad(tampaLat);
const tampaLonR=toRad(tampaLon);
const dLon=lonR-tampaLonR;
const x=radius*Math.cos(latR)*Math.sin(dLon);
const y=radius*(Math.cos(tampaLatR)*Math.sin(latR)-Math.sin(tampaLatR)*Math.cos(latR)*Math.cos(dLon));
return{x:cx+x,y:cy-y,visible:Math.cos(latR)*Math.cos(dLon)>0};
}

// Draw more detailed landmasses
ctx.fillStyle='#3a8f3a';
ctx.strokeStyle='rgba(45,80,22,0.3)';
ctx.lineWidth=0.5;

// North America - more detailed
ctx.beginPath();
const naCoords=[
[72,-140],[70,-100],[68,-70],[60,-65],[50,-55],[45,-60],[40,-70],[32,-80],
[28,-97],[25,-98],[22,-105],[18,-110],[25,-115],[35,-120],[45,-125],[55,-130],
[65,-140],[72,-140]
];
let first=true;
naCoords.forEach(([lat,lon])=>{
const pt=latLonToXY(lat,lon);
if(pt.visible){
if(first){ctx.moveTo(pt.x,pt.y);first=false;}
else ctx.lineTo(pt.x,pt.y);
}
});
ctx.closePath();
ctx.fill();
ctx.stroke();

// Central America
ctx.beginPath();
const caCoords=[
[22,-105],[18,-95],[15,-88],[10,-85],[8,-80],[10,-78],[15,-82],[20,-90],[22,-105]
];
first=true;
caCoords.forEach(([lat,lon])=>{
const pt=latLonToXY(lat,lon);
if(pt.visible){
if(first){ctx.moveTo(pt.x,pt.y);first=false;}
else ctx.lineTo(pt.x,pt.y);
}
});
ctx.closePath();
ctx.fill();
ctx.stroke();

// South America - more detailed
ctx.beginPath();
const saCoords=[
[12,-72],[10,-75],[5,-78],[0,-79],[-5,-80],[-15,-77],[-25,-71],[-35,-72],
[-45,-73],[-52,-70],[-55,-68],[-54,-65],[-50,-62],[-40,-60],[-30,-58],
[-20,-55],[-10,-60],[-5,-65],[0,-70],[5,-72],[10,-70],[12,-72]
];
first=true;
saCoords.forEach(([lat,lon])=>{
const pt=latLonToXY(lat,lon);
if(pt.visible){
if(first){ctx.moveTo(pt.x,pt.y);first=false;}
else ctx.lineTo(pt.x,pt.y);
}
});
ctx.closePath();
ctx.fill();
ctx.stroke();

// Europe/Africa (partially visible from Tampa perspective)
ctx.beginPath();
const eaCoords=[
[70,25],[60,10],[50,0],[40,-5],[30,-10],[20,-15],[10,-15],[0,-10],
[-10,-5],[-20,5],[-30,15],[-35,25],[-30,35],[0,40],[30,35],[50,30],[70,25]
];
first=true;
eaCoords.forEach(([lat,lon])=>{
const pt=latLonToXY(lat,lon);
if(pt.visible){
if(first){ctx.moveTo(pt.x,pt.y);first=false;}
else ctx.lineTo(pt.x,pt.y);
}
});
ctx.closePath();
ctx.fill();
ctx.stroke();

ctx.restore();

// Draw realistic terminator with gradual twilight zone
ctx.save();
ctx.beginPath();
ctx.arc(cx,cy,radius,0,Math.PI*2);
ctx.clip();

// Function to calculate sun angle for any point on visible hemisphere
function getSunAngle(lat,lon){
const latR=toRad(lat);
const lonR=toRad(lon);
const sunLon=0; // Noon at prime meridian
const sunLonR=toRad(sunLon);
const dLon=lonR-sunLonR;

// Calculate solar elevation angle
const sinAlt=Math.sin(latR)*Math.sin(decRad)+Math.cos(latR)*Math.cos(decRad)*Math.cos(dLon);
return Math.asin(sinAlt);
}

// Draw pixel-by-pixel terminator with smooth gradient
const imageData=ctx.createImageData(w,h);
const data=imageData.data;

for(let py=0;py<h;py++){
for(let px=0;px<w;px++){
const dx=px-cx;
const dy=py-cy;
const distFromCenter=Math.sqrt(dx*dx+dy*dy);

if(distFromCenter<=radius){
// Convert pixel position back to lat/lon
const x=dx/radius;
const y=-dy/radius;
const rho=Math.sqrt(x*x+y*y);

if(rho<=1){
const c=Math.asin(rho);
const latR=Math.asin(Math.cos(c)*Math.sin(toRad(tampaLat))+y*Math.sin(c)*Math.cos(toRad(tampaLat))/rho);
const lonR=toRad(tampaLon)+Math.atan2(x*Math.sin(c),rho*Math.cos(toRad(tampaLat))*Math.cos(c)-y*Math.sin(toRad(tampaLat))*Math.sin(c));
const lat=toDeg(latR);
const lon=toDeg(lonR);

// Calculate sun angle at this point
const sunAngle=getSunAngle(lat,lon);
const sunAngleDeg=toDeg(sunAngle);

// Create smooth twilight gradient
let darkness=0;
if(sunAngleDeg<-18){
// Full night (astronomical twilight)
darkness=0.8;
}else if(sunAngleDeg<-12){
// Astronomical twilight
darkness=0.65+0.15*(sunAngleDeg+18)/6;
}else if(sunAngleDeg<-6){
// Nautical twilight
darkness=0.45+0.2*(sunAngleDeg+12)/6;
}else if(sunAngleDeg<0){
// Civil twilight
darkness=0.15+0.3*(sunAngleDeg+6)/6;
}else if(sunAngleDeg<6){
// Early day
darkness=0.05+0.1*(6-sunAngleDeg)/6;
}else{
// Full daylight
darkness=0;
}

const idx=(py*w+px)*4;
data[idx+3]=Math.floor(darkness*255); // Alpha channel for darkness
}
}
}
}

// Apply the terminator overlay
ctx.fillStyle='rgba(0,0,0,1)';
ctx.putImageData(imageData,0,0);

ctx.restore();

// Draw atmospheric glow
const glowGrad=ctx.createRadialGradient(cx,cy,radius*0.98,cx,cy,radius*1.12);
glowGrad.addColorStop(0,'rgba(135,206,250,0)');
glowGrad.addColorStop(0.7,'rgba(135,206,250,0.2)');
glowGrad.addColorStop(0.9,'rgba(100,180,240,0.15)');
glowGrad.addColorStop(1,'rgba(70,130,180,0)');
ctx.fillStyle=glowGrad;
ctx.beginPath();
ctx.arc(cx,cy,radius*1.12,0,Math.PI*2);
ctx.fill();

// Draw sun indicator
const sunAngle=declination>0?-Math.PI/3.5:-Math.PI/2.5;
const sunDist=radius*1.4;
const sunX=cx+sunDist*Math.cos(sunAngle);
const sunY=cy+sunDist*Math.sin(sunAngle);

// Sun glow
const sunGlowGrad=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,18);
sunGlowGrad.addColorStop(0,'rgba(255,240,150,1)');
sunGlowGrad.addColorStop(0.4,'rgba(255,220,100,0.8)');
sunGlowGrad.addColorStop(1,'rgba(255,200,80,0)');
ctx.fillStyle=sunGlowGrad;
ctx.beginPath();
ctx.arc(sunX,sunY,18,0,Math.PI*2);
ctx.fill();

// Sun core
ctx.fillStyle='#ffeb3b';
ctx.beginPath();
ctx.arc(sunX,sunY,9,0,Math.PI*2);
ctx.fill();

// Sun rays
ctx.strokeStyle='rgba(255,235,100,0.5)';
ctx.lineWidth=1.5;
for(let i=0;i<8;i++){
const rayAngle=sunAngle+(i*Math.PI/4);
ctx.beginPath();
ctx.moveTo(sunX+13*Math.cos(rayAngle),sunY+13*Math.sin(rayAngle));
ctx.lineTo(sunX+23*Math.cos(rayAngle),sunY+23*Math.sin(rayAngle));
ctx.stroke();
}

// Date label
ctx.fillStyle='#fff';
ctx.font='bold 14px Arial';
ctx.textAlign='center';
ctx.shadowColor='rgba(0,0,0,0.8)';
ctx.shadowBlur=4;
const dateStr=fmtMD(dateFromDay(new Date().getFullYear(),day));
ctx.fillText(dateStr,cx,h-15);
ctx.shadowBlur=0;
}

function syncFromSlider(){
updateAnnotationsOnly();
}

function populateSelectors(){
const refSel=document.getElementById("referenceCity");
const compSel=document.getElementById("compareCity");
cities.forEach((c,i)=>{
const opt1=document.createElement("option");
opt1.value=i;
opt1.textContent=`${c.name}, ${c.country}`;
refSel.appendChild(opt1);
const opt2=document.createElement("option");
opt2.value=i;
opt2.textContent=`${c.name}, ${c.country}`;
compSel.appendChild(opt2);
});
}

function findClosestCity(lat,lon){
let closest=0,minDist=Infinity;
cities.forEach((c,i)=>{
const dist=Math.sqrt((c.lat-lat)**2+(c.lon-lon)**2);
if(dist<minDist){
minDist=dist;
closest=i;
}
});
return closest;
}

function initWithGeolocation(){
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(pos=>{
const closest=findClosestCity(pos.coords.latitude,pos.coords.longitude);
document.getElementById("referenceCity").selectedIndex=closest;
updateAll();
},()=>{
document.getElementById("referenceCity").selectedIndex=0;
updateAll();
});
}else{
document.getElementById("referenceCity").selectedIndex=0;
updateAll();
}
}

function init(){
populateSelectors();
document.getElementById("compareCity").selectedIndex=16;
const now=new Date();
document.getElementById("dateSlider").value=dayOfYear(now);
initWithGeolocation();
}

document.getElementById("dateSlider").addEventListener("input",syncFromSlider);
document.getElementById("referenceCity").addEventListener("change",updateAll);
document.getElementById("compareCity").addEventListener("change",updateAll);
document.getElementById("hoursBtn").addEventListener("click",()=>{
mode="hours";
hoursBtn.classList.add("active");
elevBtn.classList.remove("active");
updateAll();
});
document.getElementById("elevBtn").addEventListener("click",()=>{
mode="elev";
elevBtn.classList.add("active");
hoursBtn.classList.remove("active");
updateAll();
});
window.addEventListener("DOMContentLoaded",init);
</script>
</body>
</html>
