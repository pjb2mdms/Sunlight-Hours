<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunlight Angle Comparator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
  body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    background: #fff;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #003c78;
    color: #fff;
    padding: 1.5rem 0;
    text-align: center;
  }
  main {
    max-width: 900px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  h1 {
    margin: 0;
    font-weight: 600;
    font-size: 1.6rem;
  }
  .dates {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    margin: 1.5rem 0;
  }
  label {
    font-weight: 500;
    margin-right: 0.4rem;
  }
  input[type="date"], input[readonly] {
    font-size: 1rem;
    padding: 0.3rem 0.4rem;
  }
  .city-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem 1rem;
    justify-content: center;
    margin-bottom: 1rem;
  }
  button {
    background: #003c78;
    color: white;
    border: none;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 4px;
    cursor: pointer;
  }
  button:hover {
    background: #004a96;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
    margin-top: 1.5rem;
  }
  th, td {
    border-bottom: 1px solid #e0e0e0;
    padding: 0.4rem;
    text-align: center;
  }
  th.label-col {
    text-align: left;
    width: 150px;
  }
  td svg {
    width: 60px;
    height: 30px;
    vertical-align: middle;
  }
  canvas {
    width: 100% !important;
    height: 400px !important;
    margin-top: 2rem;
  }
</style>
</head>
<body>
  <header>
    <h1>Sunlight Angle Comparator</h1>
  </header>

  <main>
    <div class="dates">
      <div>
        <label for="dateInput">Selected Date:</label>
        <input type="date" id="dateInput" value="2025-06-21">
      </div>
      <div>
        <label for="equivDate">Equivalent Date:</label>
        <input type="text" id="equivDate" readonly value="—">
      </div>
    </div>

    <div class="city-list" id="cityList"></div>

    <div style="text-align:center; margin-bottom: 1.5rem;">
      <button onclick="compareCities()">Compare</button>
    </div>

    <table id="resultsTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <canvas id="daylightChart"></canvas>
  </main>

<script>
  /* ---------- City Data ---------- */
  const cityData = {
    "Fairbanks, AK": { abbr: "FAI", lat: 64.84, lon: -147.72 },
    "St Andrews, Scotland": { abbr: "STA", lat: 56.34, lon: -2.80 },
    "Hanover, NH": { abbr: "HAN", lat: 43.70, lon: -72.29 },
    "East Longmeadow, MA": { abbr: "ELM", lat: 42.06, lon: -72.51 },
    "Crozet, VA": { abbr: "CRZ", lat: 38.07, lon: -78.70 },
    "Nashville, TN": { abbr: "BNA", lat: 36.16, lon: -86.78 },
    "Asheville, NC": { abbr: "AVL", lat: 35.60, lon: -82.55 },
    "Houston, TX": { abbr: "HOU", lat: 29.76, lon: -95.37 },
    "Tampa, FL": { abbr: "TPA", lat: 27.95, lon: -82.46 }
  };

  /* ---------- Utility Functions ---------- */
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => r * 180 / Math.PI;

  function solarDeclination(day) {
    return 23.44 * Math.sin(toRad((360 / 365) * (day - 81)));
  }

  function daylightHours(lat, day) {
    const dec = toRad(solarDeclination(day));
    const latR = toRad(lat);
    const cosH = -Math.tan(latR) * Math.tan(dec);
    if (cosH >= 1) return 0;
    if (cosH <= -1) return 24;
    const H = Math.acos(cosH);
    return (2 * toDeg(H)) / 15;
  }

  function noonElevation(lat, day) {
    const dec = solarDeclination(day);
    return 90 - Math.abs(lat - dec);
  }

  function dayOfYear(date) {
    const start = new Date(date.getFullYear(), 0, 0);
    const diff = date - start + (start.getTimezoneOffset() - date.getTimezoneOffset()) * 60000;
    return Math.floor(diff / 86400000);
  }

  function findEquivalentDate(lat, targetHours, refDay, year) {
    let bestDay = null, bestDiff = 999;
    for (let d = 1; d <= 365; d++) {
      if (Math.abs(d - refDay) < 5) continue;
      const diff = Math.abs(daylightHours(lat, d) - targetHours);
      if (diff < bestDiff) {
        bestDiff = diff;
        bestDay = d;
      }
    }
    return bestDay ? new Date(year, 0, bestDay) : null;
  }

  function formatDate(date) {
    const mm = String(date.getMonth() + 1).padStart(2, '0');
    const dd = String(date.getDate()).padStart(2, '0');
    const yyyy = date.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }

  /* ---------- Setup City List ---------- */
  const cityList = document.getElementById("cityList");
  Object.entries(cityData)
    .sort((a,b)=>b[1].lat - a[1].lat)
    .forEach(([city]) => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${city}"> ${city}`;
      cityList.appendChild(label);
    });

  /* ---------- Table Builder with Visual Noon Elevation ---------- */
  function buildTable(selected, refDay) {
    const head = document.getElementById("tableHead");
    const body = document.getElementById("tableBody");
    head.innerHTML = "";
    body.innerHTML = "";

    const headRow = document.createElement("tr");
    headRow.innerHTML = `<th class="label-col"></th>` +
      selected.map(city => `<th>${cityData[city].abbr}</th>`).join('');
    head.appendChild(headRow);

    const addRow = (label, fn) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td class="label-col">${label}</td>` +
        selected.map(c => `<td>${fn(c)}</td>`).join('');
      body.appendChild(tr);
    };

    addRow("Latitude", c => cityData[c].lat.toFixed(2));
    addRow("Longitude", c => cityData[c].lon.toFixed(2));

    // Noon elevation with simple arcs
    addRow("Noon Elevation", c => {
      const elev = noonElevation(cityData[c].lat, refDay);
      const radius = 28;
      const endAngle = Math.min(90, elev) * Math.PI / 180;
      const x = 30 + radius * Math.cos(Math.PI - endAngle);
      const y = 28 - radius * Math.sin(Math.PI - endAngle);
      return `
        <svg viewBox="0 0 60 30">
          <path d="M2 28 A28 28 0 0 1 58 28" stroke="#ccc" stroke-width="1" fill="none"/>
          <line x1="30" y1="28" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="orange" stroke-width="2"/>
          <circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="3" fill="orange"/>
        </svg>
        <div>${elev.toFixed(1)}°</div>`;
    });

    addRow("Daylight (hrs)", c => daylightHours(cityData[c].lat, refDay).toFixed(2));
  }

  /* ---------- Chart ---------- */
  let daylightChart;

  function plotChart(selected, eqDateObj, refDay) {
    const ctx = document.getElementById('daylightChart').getContext('2d');
    const days = Array.from({length:365}, (_,i)=>i+1);

    const datasets = selected.map((city, idx) => {
      const lat = cityData[city].lat;
      const data = days.map(d => daylightHours(lat, d));
      const color = idx % 2 === 0 ? "#003c78" : "#f28e2b";
      return { label: cityData[city].abbr, data, borderColor: color, fill: false, tension: 0.25, borderWidth: 2 };
    });

    if (daylightChart) daylightChart.destroy();

    const annotations = {
      selectedDate: { type: 'line', xMin: refDay, xMax: refDay, borderColor: 'black', borderWidth: 2 }
    };
    if (eqDateObj) {
      annotations.equivalentDate = { type: 'line', xMin: dayOfYear(eqDateObj), xMax: dayOfYear(eqDateObj), borderColor: 'red', borderWidth: 2 };
    }

    const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monthPositions = [15,45,74,105,135,166,196,227,258,288,319,349];

    daylightChart = new Chart(ctx, {
      type: 'line',
      data: { labels: days, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          annotation: { annotations }
        },
        scales: {
          x: {
            title: { display: true, text: 'Month' },
            ticks: {
              callback: function(value) {
                const day = days[value];
                for (let i = 0; i < monthPositions.length; i++) {
                  if (Math.abs(day - monthPositions[i]) < 3) return monthLabels[i];
                }
                return "";
              },
              maxRotation: 0,
              autoSkip: false
            },
            grid: { color: "#eee" }
          },
          y: {
            title: { display: true, text: 'Daylight Hours' },
            min: 5, max: 20,
            grid: { color: "#eee" }
          }
        }
      },
      plugins: [Chart.registry.getPlugin('annotation')]
    });
  }

  /* ---------- Main ---------- */
  function compareCities() {
    const selected = Array.from(document.querySelectorAll("#cityList input:checked")).map(cb => cb.value);
    if (selected.length === 0) { alert("Select at least one city."); return; }

    const dateVal = document.getElementById("dateInput").value;
    const date = new Date(dateVal);
    const refDay = dayOfYear(date);
    const year = date.getFullYear();

    const refCity = selected[0];
    const refLat = cityData[refCity].lat;
    const refHours = daylightHours(refLat, refDay);
    const eqDateObj = findEquivalentDate(refLat, refHours, refDay, year);
    document.getElementById("equivDate").value = eqDateObj ? formatDate(eqDateObj) : "—";

    buildTable(selected, refDay);
    plotChart(selected, eqDateObj, refDay);
  }
</script>
</body>
</html>
