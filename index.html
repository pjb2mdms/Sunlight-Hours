<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sunlight Comparator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
  :root{
    --blue:#0b5fb3;
    --blue-dark:#084a8b;
    --orange:#f28e2b;
    --text:#222;
    --grid:#eee;
  }
  *{box-sizing:border-box}
  body{
    font-family: "Helvetica Neue", Arial, sans-serif;
    margin:0; color:var(--text); background:#fff;
  }
  header{
    background:var(--blue);
    color:#fff; text-align:center; padding:1.25rem 0;
  }
  header h1{margin:0; font-weight:700; letter-spacing:.2px}
  main{max-width:980px; margin:1.25rem auto 3rem; padding:0 1rem}
  .controls{
    display:flex; flex-wrap:wrap; gap:1rem; justify-content:center; align-items:center;
    margin:1rem 0 0.5rem;
  }
  label{font-weight:600; margin-right:.35rem}
  input[type="date"], input[readonly]{
    font: inherit; font-size:1rem; color:#333;
    padding:.45rem .55rem; border:1px solid #cfd6e1; border-radius:.5rem;
    background:#fff; min-width:12rem;
  }
  .city-list{
    display:flex; flex-wrap:wrap; gap:.6rem 1rem; justify-content:center; margin:.75rem 0 1rem;
  }
  .city-list label{font-weight:500}
  .btn{
    display:inline-block; background:var(--blue); color:#fff; border:none; border-radius:.6rem;
    padding:.6rem 1.1rem; font-size:1rem; cursor:pointer;
  }
  .btn:hover{background:var(--blue-dark)}
  table{width:100%; border-collapse:collapse; margin:1.1rem 0 0; font-size:1rem}
  th,td{padding:.5rem .4rem; border-bottom:1px solid #e9eef5; text-align:center}
  th.label-col{text-align:left; width:180px}
  td svg{width:80px; height:46px; vertical-align:middle}
  .chart-wrap{margin-top:1.25rem}
  canvas{width:100% !important; height:420px !important}
  .slider-area{margin-top:1rem; text-align:center}
  .live-dates{font-weight:700; margin:.25rem 0 .6rem}
  .live-dates span{display:inline-block; min-width:9rem}
  input[type="range"]{
    -webkit-appearance:none; appearance:none; width:100%; max-width:720px; height:10px;
    background:#e6eef8; border-radius:5px; outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none; width:24px; height:24px; border-radius:50%;
    background:var(--blue); border:2px solid #fff; box-shadow:0 0 0 2px var(--blue);
    cursor:pointer;
  }
  input[type="range"]::-moz-range-thumb{
    width:24px; height:24px; border-radius:50%; background:var(--blue);
    border:2px solid #fff; box-shadow:0 0 0 2px var(--blue); cursor:pointer;
  }
  .note{font-size:.9rem; color:#555; text-align:center; margin-top:.35rem}

  /* Fade-in effect for smoother visual updates */
  .fade-in {
    opacity: 0;
    transition: opacity 0.6s ease-in;
  }
  .fade-in.show {
    opacity: 1;
  }
</style>
</head>
<body>
<header><h1>Sunlight Comparator</h1></header>

<main>
  <!-- Date controls -->
  <div class="controls">
    <div>
      <label for="dateInput">Selected Date</label>
      <input type="date" id="dateInput">
    </div>
    <div>
      <label for="equivDate">Equivalent Date</label>
      <input type="text" id="equivDate" readonly value="—">
    </div>
  </div>

  <!-- City selection -->
  <div class="city-list" id="cityList"></div>
  <div style="text-align:center;"><button class="btn" id="compareBtn">Compare</button></div>

  <!-- Results table -->
  <table id="resultsTable" class="fade-in">
    <thead id="tableHead"></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <!-- Chart + slider -->
  <div class="chart-wrap fade-in" id="chartContainer">
    <canvas id="daylightChart"></canvas>

    <div class="slider-area">
      <div class="live-dates">
        <span id="selectedLabel">Selected: —</span>
        <span id="equivLabel">Equivalent: —</span>
      </div>
      <input type="range" id="dateSlider" min="1" max="365" step="1" value="172" />
      <div class="note">Slide to change the date and see how daylight and noon sun angles change</div>
    </div>
  </div>
</main>

<script>
/* --------------------- Data & utilities --------------------- */
const cityData = {
  "Fairbanks, AK":         { abbr:"FAI", lat:64.84, lon:-147.72 },
  "St Andrews, Scotland":  { abbr:"STA", lat:56.34, lon:-2.80 },
  "Hanover, NH":           { abbr:"HAN", lat:43.70, lon:-72.29 },
  "East Longmeadow, MA":   { abbr:"ELM", lat:42.06, lon:-72.51 },
  "Crozet, VA":            { abbr:"CRZ", lat:38.07, lon:-78.70 },
  "Nashville, TN":         { abbr:"BNA", lat:36.16, lon:-86.78 },
  "Asheville, NC":         { abbr:"AVL", lat:35.60, lon:-82.55 },
  "Houston, TX":           { abbr:"HOU", lat:29.76, lon:-95.37 },
  "Tampa, FL":             { abbr:"TPA", lat:27.95, lon:-82.46 }
};
const cityListEl = document.getElementById("cityList");
Object.entries(cityData).sort((a,b)=>b[1].lat - a[1].lat).forEach(([name])=>{
  const label = document.createElement("label");
  label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
  cityListEl.appendChild(label);
});

const toRad = d => d * Math.PI/180;
const toDeg = r => r * 180/Math.PI;
const days = Array.from({length:365},(_,i)=>i+1);

function solarDeclination(day){ return 23.44 * Math.sin(toRad((360/365)*(day-81))); }
function daylightHours(lat, day){
  const decR = toRad(solarDeclination(day));
  const latR = toRad(lat);
  const cosH = -Math.tan(latR)*Math.tan(decR);
  if (cosH >= 1) return 0;
  if (cosH <= -1) return 24;
  const H = Math.acos(cosH);
  return (2*toDeg(H))/15;
}
function noonElevation(lat, day){ const dec = solarDeclination(day); return 90 - Math.abs(lat - dec); }
function dayOfYear(date){
  const start = new Date(date.getFullYear(),0,0);
  const diff = date - start + (start.getTimezoneOffset()-date.getTimezoneOffset())*60000;
  return Math.floor(diff/86400000);
}
function dateFromDay(year, doy){ return new Date(year,0,doy); }
function fmtMD(date){ return date.toLocaleDateString("en-US",{month:"short", day:"numeric"}); }
function fmtMMDDYYYY(date){
  const mm = String(date.getMonth()+1).padStart(2,'0');
  const dd = String(date.getDate()).padStart(2,'0');
  return `${mm}/${dd}/${date.getFullYear()}`;
}
function findEquivalentDate(lat, targetHours, refDay, year){
  let bestDay=null, bestDiff=1e9;
  for(let d=1; d<=365; d++){
    if (Math.abs(d-refDay) < 5) continue;
    const diff = Math.abs(daylightHours(lat,d)-targetHours);
    if (diff < bestDiff){ bestDiff=diff; bestDay=d; }
  }
  return bestDay ? dateFromDay(year, bestDay) : null;
}

/* --------------------- Table builder --------------------- */
function buildTable(selected, refDay){
  const head = document.getElementById("tableHead");
  const body = document.getElementById("tableBody");
  head.innerHTML = ""; body.innerHTML = "";

  const headRow = document.createElement("tr");
  headRow.innerHTML = `<th class="label-col">Measure</th>` +
    selected.map(c=>`<th>${cityData[c].abbr}</th>`).join("");
  head.appendChild(headRow);

  const addRow = (label, fn) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="label-col">${label}</td>` +
      selected.map(c=>`<td>${fn(c)}</td>`).join("");
    body.appendChild(tr);
  };

  addRow("Latitude",   c => cityData[c].lat.toFixed(2));
  addRow("Longitude",  c => cityData[c].lon.toFixed(2));
  addRow("Noon Elevation", c => {
    const elev = noonElevation(cityData[c].lat, refDay);
    const R = 32;
    const a = Math.min(90, Math.max(0, elev)) * Math.PI/180;
    const x = 30 + R * Math.cos(Math.PI - a);
    const y = 34 - R * Math.sin(Math.PI - a);
    return `
      <svg viewBox="0 0 70 40" aria-label="Noon sun elevation">
        <path d="M4 34 A32 32 0 0 1 64 34" stroke="#c9d3e3" stroke-width="1.2" fill="none"/>
        <line x1="30" y1="34" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}" stroke="${getCityColor(c)}" stroke-width="3"/>
        <circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="4.2" fill="${getCityColor(c)}"/>
      </svg>
      <div>${elev.toFixed(1)}°</div>`;
  });
  addRow("Daylight (hrs)", c => daylightHours(cityData[c].lat, refDay).toFixed(2));
}

/* --------------------- Chart --------------------- */
let chart;
function getCityColor(cityName){
  const idx = Object.keys(cityData).indexOf(cityName);
  const colors = ["#0b5fb3","#f28e2b","#59a14f","#e15759","#4e79a7","#edc948","#b07aa1","#76b7b2","#ff9da7"];
  return colors[idx % colors.length];
}
function plotChart(selected, eqDateObj, refDay){
  const ctx = document.getElementById("daylightChart").getContext("2d");
  const year = new Date(document.getElementById("dateInput").value).getFullYear();
  const datasets = selected.map((city)=>({
    label: cityData[city].abbr,
    data: days.map(d=>daylightHours(cityData[city].lat, d)),
    borderColor: getCityColor(city),
    borderWidth: 2,
    fill:false,
    tension:.25,
    pointRadius:0
  }));
  if (chart) chart.destroy();
  const annotations = {};
  const selDate = dateFromDay(year, refDay);
  annotations.selected = {
    type:'line', xMin:refDay, xMax:refDay,
    borderColor:'#000', borderWidth:2,
    label:{enabled:true, content:fmtMD(selDate), position:'start', yAdjust:-10,
      backgroundColor:'rgba(255,255,255,.8)', color:'#000'}
  };
  if (eqDateObj){
    const eqDay = dayOfYear(eqDateObj);
    annotations.equivalent = {
      type:'line', xMin:eqDay, xMax:eqDay,
      borderColor:'#e11d48', borderWidth:2,
      label:{enabled:true, content:fmtMD(eqDateObj), position:'start', yAdjust:-10,
        backgroundColor:'rgba(255,255,255,.85)', color:'#e11d48'}
    };
  }
  chart = new Chart(ctx, {
    type:'line',
    data:{labels:days,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}, annotation:{annotations}},
      scales:{
        x:{display:false,min:1,max:365},
        y:{title:{display:true,text:'Daylight Hours'},min:5,max:20,grid:{color:'#f4f5f7'}}
      }
    },
    plugins:[Chart.registry.getPlugin('annotation')]
  });
}

/* --------------------- Slider + interactions --------------------- */
const dateInput  = document.getElementById("dateInput");
const equivEl    = document.getElementById("equivDate");
const slider     = document.getElementById("dateSlider");
const selectedLbl= document.getElementById("selectedLabel");
const equivLbl   = document.getElementById("equivLabel");
const compareBtn = document.getElementById("compareBtn");

function currentSelectedCities(){
  return Array.from(document.querySelectorAll('#cityList input:checked')).map(cb=>cb.value);
}
function syncFromDateInput(){
  const d = new Date(dateInput.value);
  slider.value = String(dayOfYear(d));
  updateAll();
}
function syncFromSlider(){
  const d = new Date(dateInput.value);
  const year = d.getFullYear();
  const newDate = dateFromDay(year, Number(slider.value));
  dateInput.value = newDate.toISOString().slice(0,10);
  updateAll();
}
function updateAll(){
  const selected = currentSelectedCities();
  if (selected.length === 0){
    const defaults = ["Tampa, FL","St Andrews, Scotland"];
    defaults.forEach(name=>{
      const cb = Array.from(document.querySelectorAll('#cityList input')).find(x=>x.value===name);
      if (cb) cb.checked = true;
    });
    selected.push(...defaults);
  }
  const d = new Date(dateInput.value);
  const refDay = dayOfYear(d);
  const year = d.getFullYear();
  const refCity = selected[0];
  const refLat = cityData[refCity].lat;
  const refHrs = daylightHours(refLat, refDay);
  const eqDate = findEquivalentDate(refLat, refHrs, refDay, year);
  equivEl.value = eqDate ? fmtMMDDYYYY(eqDate) : "—";
  selectedLbl.textContent = `Selected: ${fmtMD(d)}`;
  equivLbl.textContent = `Equivalent: ${eqDate ? fmtMD(eqDate) : "—"}`;
  buildTable(selected, refDay);
  plotChart(selected, eqDate, refDay);
  // Fade in
  document.getElementById("resultsTable").classList.add("show");
  document.getElementById("chartContainer").classList.add("show");
}

/* --------------------- Init --------------------- */
(function init(){
  ["Tampa, FL","St Andrews, Scotland"].forEach(name=>{
    const cb = Array.from(document.querySelectorAll('#cityList input')).find(x=>x.value===name);
    if (cb) cb.checked = true;
  });
  // Set selected date to today
  const today = new Date();
  document.getElementById("dateInput").value = today.toISOString().split("T")[0];
  // Render immediately
  syncFromDateInput();
})();
compareBtn.addEventListener("click", updateAll);
dateInput.addEventListener("change", syncFromDateInput);
slider.addEventListener("input", syncFromSlider);
</script>
</body>
</html>
