<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Solar Energy Comparator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0b5fb3; --orange: #f28e2b; --bg: #f8fafc; --card: #fff; --text: #1e293b; --red: #e11d48; }
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 0; color: var(--text); background: var(--bg); }
        header { background: linear-gradient(135deg, #0b5fb3 0%, #084a8f 100%); color: #fff; text-align: center; padding: 2rem 1rem; box-shadow: 0 2px 8px rgba(0,0,0,.1); }
        main { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; box-shadow: 0 1px 3px rgba(0,0,0,.08); }
        
        .city-selectors { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1rem; }
        .selector-group { display: flex; flex-direction: column; gap: .5rem; }
        select { padding: .7rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 1rem; background: white; }

        .controls { display: flex; flex-direction: column; gap: 1rem; background: #f1f5f9; padding: 1.2rem; border-radius: 8px; margin-bottom: 1.5rem; }
        input[type="range"] { width: 100%; cursor: pointer; }

        .tabs { display: flex; gap: 1rem; margin-bottom: 1.5rem; justify-content: center; }
        .tabs button { padding: 1rem 2rem; border-radius: 12px; border: 2px solid #e2e8f0; cursor: pointer; background: white; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 8px; }
        .tabs button.active { background: var(--blue); color: white; border-color: var(--blue); }

        .display-grid { display: grid; grid-template-columns: 1fr 320px; gap: 1.5rem; }
        @media (max-width: 850px) { .display-grid { grid-template-columns: 1fr; } }

        .chart-container { position: relative; height: 400px; }
        .stats-panel { background: #f8fafc; border-radius: 8px; padding: 1rem; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 1rem; }
        
        .stat-card { background: white; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; text-align: center; }
        .stat-value { font-size: 2.2rem; font-weight: bold; color: var(--blue); line-height: 1; }
        .stat-label { font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
        
        .equiv-badge { background: #fff1f2; color: var(--red); padding: 0.8rem; border-radius: 8px; border: 1px solid #fecdd3; font-size: 0.9rem; text-align: center; }
        .equiv-date { font-weight: 800; display: block; font-size: 1.1rem; }

        .info-box { background: #e0f2fe; border-left: 4px solid var(--blue); padding: 1rem; border-radius: 4px; font-size: 0.85rem; line-height: 1.4; }
    </style>
</head>
<body>

<header>
    <h1>‚òÄÔ∏è Solar Comparator</h1>
    <p>Physics-based comparison of light duration and energy flux</p>
</header>

<main>
    <div class="card city-selectors">
        <div class="selector-group">
            <label>City A (The Baseline)</label>
            <select id="cityA"></select>
        </div>
        <div class="selector-group">
            <label>City B (Compare to...)</label>
            <select id="cityB"></select>
        </div>
    </div>

    <div class="card">
        <div class="controls">
            <div style="display:flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem;">
                <span>üìÖ Date: <span id="dateLabel"></span></span>
                <span>‚òÅÔ∏è Cloud Factor: <span id="cloudLabel">30%</span></span>
            </div>
            <input type="range" id="daySlider" min="1" max="365">
            <input type="range" id="cloudSlider" min="0" max="100" value="30">
        </div>

        <div class="tabs">
            <button id="tabHours" class="active">üìä Daylight Hours</button>
            <button id="tabFlux">‚ö° Integrated Flux</button>
        </div>

        <div class="display-grid">
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
            <div class="stats-panel">
                <div class="stat-card">
                    <div class="stat-label" id="nameA">City A</div>
                    <div class="stat-value" id="valA">0</div>
                    <div id="subA" style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;"></div>
                </div>

                <div class="stat-card">
                    <div class="stat-label" id="nameB">City B</div>
                    <div class="stat-value" id="valB" style="color: var(--orange);">0</div>
                    <div id="subB" style="font-size: 0.8rem; color: #94a3b8; margin-top: 4px;"></div>
                </div>

                <div class="equiv-badge" id="equivContainer">
                    <span id="equivText">Today in City A is like</span>
                    <span class="equiv-date" id="equivDate">‚Äî</span>
                    <span id="equivContext">in City B</span>
                </div>

                <div class="info-box" id="explanation">
                    Toggle to see how City B matches up.
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const cities = [
        { name: "Tampa, FL", lat: 27.95, lon: -82.46 },
        { name: "East Longmeadow, MA", lat: 42.06, lon: -72.51 },
        { name: "Reykjavik, Iceland", lat: 64.13, lon: -21.82 },
        { name: "Phoenix, AZ", lat: 33.45, lon: -112.07 },
        { name: "London, UK", lat: 51.51, lon: -0.13 },
        { name: "Sydney, AU", lat: -33.86, lon: 151.20 }
    ];

    let currentMode = 'hours'; 
    let chart;
    const toRad = (d) => d * Math.PI / 180;

    function getSolarParams(lat, day, hour) {
        const declination = 23.45 * Math.sin(toRad((360 / 365) * (day - 81)));
        const l = toRad(lat);
        const d = toRad(declination);
        const h = toRad((hour - 12) * 15);
        const sinAlt = Math.sin(l) * Math.sin(d) + Math.cos(l) * Math.cos(d) * Math.cos(h);
        const alt = Math.asin(sinAlt);
        return { alt: Math.max(0, alt), sinAlt: Math.max(0, sinAlt) };
    }

    // Returns a single numeric value for a city/day/mode to allow comparisons
    function getMetric(lat, day, cloudFactor, mode) {
        let total = 0;
        for (let h = 0; h <= 24; h += 0.25) {
            const p = getSolarParams(lat, day, h);
            if (p.alt > 0) {
                if (mode === 'hours') {
                    total += 0.25;
                } else {
                    // Flux with Air Mass attenuation
                    total += (Math.pow(0.7, 1/Math.sin(p.alt)) * p.sinAlt * cloudFactor) * 0.25;
                }
            }
        }
        return total;
    }

    function findEquivDate(targetVal, cityBLat, cloudFactor, mode) {
        let bestDay = 1, minDiff = Infinity;
        // Scan the year to find the closest match in City B
        for (let d = 1; d <= 365; d++) {
            const val = getMetric(cityBLat, d, cloudFactor, mode);
            const diff = Math.abs(val - targetVal);
            if (diff < minDiff) {
                minDiff = diff;
                bestDay = d;
            }
        }
        // If the best match is still very far off (e.g., Iceland in winter vs Tampa), return null
        if (mode === 'hours' && minDiff > 0.5) return null;
        if (mode === 'flux' && minDiff > 1.5) return null;
        
        return new Date(2026, 0, bestDay).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function calculateData() {
        const cityA = cities[document.getElementById('cityA').selectedIndex];
        const cityB = cities[document.getElementById('cityB').selectedIndex];
        const day = parseInt(document.getElementById('daySlider').value);
        const cloudVal = parseInt(document.getElementById('cloudSlider').value);
        const cloudFactor = 1 - (cloudVal / 100);
        
        const labels = [], dataA = [], dataB = [];
        let valA = getMetric(cityA.lat, day, cloudFactor, currentMode);
        let valB = getMetric(cityB.lat, day, cloudFactor, currentMode);

        // Populate Chart
        for (let h = 4; h <= 21; h += 0.25) {
            labels.push(h % 1 === 0 ? (h > 12 ? (h-12)+'pm' : h+'am') : '');
            const pA = getSolarParams(cityA.lat, day, h);
            const pB = getSolarParams(cityB.lat, day, h);
            
            if (currentMode === 'hours') {
                dataA.push(pA.alt > 0 ? 1 : 0);
                dataB.push(pB.alt > 0 ? 1 : 0);
            } else {
                dataA.push(pA.alt > 0 ? (Math.pow(0.7, 1/Math.sin(pA.alt)) * pA.sinAlt * cloudFactor) : 0);
                dataB.push(pB.alt > 0 ? (Math.pow(0.7, 1/Math.sin(pB.alt)) * pB.sinAlt * cloudFactor) : 0);
            }
        }

        const equiv = findEquivDate(valA, cityB.lat, cloudFactor, currentMode);
        updateUI(cityA.name, cityB.name, valA, valB, day, equiv);
        renderChart(labels, dataA, dataB, cityA.name, cityB.name);
    }

    function updateUI(nA, nB, vA, vB, day, equiv) {
        const date = new Date(2026, 0, day);
        document.getElementById('dateLabel').innerText = date.toLocaleDateString('en-US', {month:'short', day:'numeric'});
        document.getElementById('nameA').innerText = nA;
        document.getElementById('nameB').innerText = nB;

        if (currentMode === 'hours') {
            document.getElementById('valA').innerText = vA.toFixed(1) + "h";
            document.getElementById('valB').innerText = vB.toFixed(1) + "h";
            document.getElementById('subA').innerText = "Daylight Duration";
            document.getElementById('subB').innerText = "Daylight Duration";
            document.getElementById('equivText').innerText = "Daylight in " + nA + " matches";
            document.getElementById('explanation').innerText = "Comparing how long the sun stays above the horizon.";
        } else {
            document.getElementById('valA').innerText = (vA * 15).toFixed(1);
            document.getElementById('valB').innerText = (vB * 15).toFixed(1);
            document.getElementById('subA').innerText = "Solar Energy Units";
            document.getElementById('subB').innerText = "Solar Energy Units";
            document.getElementById('equivText').innerText = "Solar Energy in " + nA + " matches";
            document.getElementById('explanation').innerText = "Comparing the total 'dose' of solar energy (Flux) reaching the ground.";
        }

        const equivEl = document.getElementById('equivDate');
        if (equiv) {
            equivEl.innerText = equiv;
            document.getElementById('equivContext').innerText = "in " + nB;
            document.getElementById('equivContainer').style.opacity = "1";
        } else {
            equivEl.innerText = "No Match";
            document.getElementById('equivContext').innerText = "in " + nB + " (Too different!)";
            document.getElementById('equivContainer').style.opacity = "0.6";
        }
    }

    function renderChart(labels, dataA, dataB, nA, nB) {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: nA, data: dataA, borderColor: '#0b5fb3', backgroundColor: 'rgba(11, 95, 179, 0.15)', fill: true, pointRadius: 0, tension: 0.4 },
                    { label: nB, data: dataB, borderColor: '#f28e2b', backgroundColor: 'rgba(242, 142, 43, 0.15)', fill: true, pointRadius: 0, tension: 0.4 }
                ]
            },
            options: { 
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        display: currentMode !== 'hours',
                        title: { display: true, text: currentMode === 'hours' ? '' : 'Energy Intensity' }
                    },
                    x: { ticks: { autoSkip: true, maxTicksLimit: 12 } }
                }
            }
        });
    }

    // Init Logic
    const selA = document.getElementById('cityA'), selB = document.getElementById('cityB');
    cities.forEach((c, i) => {
        selA.options[i] = new Option(c.name, i);
        selB.options[i] = new Option(c.name, i);
    });
    
    // Set default view (Tampa vs East Longmeadow on today's date)
    selA.selectedIndex = 0;
    selB.selectedIndex = 1;
    const today = new Date();
    const startOfYear = new Date(today.getFullYear(), 0, 0);
    const diff = today - startOfYear;
    const oneDay = 1000 * 60 * 60 * 24;
    document.getElementById('daySlider').value = Math.floor(diff / oneDay);

    document.getElementById('tabHours').addEventListener('click', function() {
        currentMode = 'hours';
        this.classList.add('active');
        document.getElementById('tabFlux').classList.remove('active');
        calculateData();
    });

    document.getElementById('tabFlux').addEventListener('click', function() {
        currentMode = 'flux';
        this.classList.add('active');
        document.getElementById('tabHours').classList.remove('active');
        calculateData();
    });

    document.getElementById('daySlider').addEventListener('input', calculateData);
    document.getElementById('cloudSlider').addEventListener('input', function() {
        document.getElementById('cloudLabel').innerText = this.value + "%";
        calculateData();
    });
    document.getElementById('cityA').addEventListener('change', calculateData);
    document.getElementById('cityB').addEventListener('change', calculateData);

    calculateData();
</script>
</body>
</html>
