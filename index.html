<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Sunlight Comparator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
<style>
:root{--blue:#0b5fb3;--orange:#f28e2b;--text:#222;}
body{font-family:"Helvetica Neue",Arial,sans-serif;margin:0;color:var(--text);}
header{background:var(--blue);color:#fff;text-align:center;padding:1.1rem 0;}
main{max-width:980px;margin:1rem auto 3rem;padding:0 1rem;}
.controls,.toggle-buttons{display:flex;flex-wrap:wrap;gap:1rem;justify-content:center;align-items:center;margin:1rem 0;}
label{font-weight:600;margin-right:.3rem}
input,select{font:inherit;font-size:1rem;padding:.4rem .55rem;border:1px solid #cfd6e1;border-radius:.5rem;}
table{width:100%;border-collapse:collapse;margin:1rem 0;font-size:1rem;table-layout:fixed;}
th,td{padding:.5rem;border-bottom:1px solid #e9eef5;text-align:center;word-wrap:break-word;}
th:first-child,td:first-child{width:180px;text-align:left;}
th:nth-child(2),td:nth-child(2),th:nth-child(3),td:nth-child(3){width:calc((100% - 180px)/2);}
td svg{width:80px;height:46px;vertical-align:middle}
canvas{width:100%!important;height:420px!important}
.toggle-buttons button{
  font:inherit;font-weight:600;margin:0 .3rem;padding:.5rem 1rem;border-radius:.5rem;border:1px solid #cfd6e1;
  cursor:pointer;background:#f7f9fb;color:#333;
}
.toggle-buttons button.active{background:var(--blue);color:#fff;border-color:var(--blue);}
.note{font-size:.9rem;color:#555;text-align:center;margin-top:.3rem;}
</style>
</head>
<body>
<header><h1>Sunlight Comparator</h1></header>

<main>
  <div class="controls">
    <div><label for="dateInput">Date</label><input type="date" id="dateInput"></div>
    <div><label for="equivDate">Equivalent Date</label><input type="text" id="equivDate" readonly></div>
    <div><label for="compareCity">Comparison City</label>
      <select id="compareCity">
        <option value="56.34,-2.80,Europe/London,St Andrews,Scotland">St Andrews, Scotland</option>
        <option value="29.76,-95.37,America/Chicago,Houston,TX">Houston, TX</option>
        <option value="38.03,-78.48,America/New_York,Charlottesville,VA">Charlottesville, VA</option>
        <option value="43.65,-70.26,America/New_York,Portland,ME">Portland, ME</option>
        <option value="34.05,-118.25,America/Los_Angeles,Los Angeles,CA">Los Angeles, CA</option>
      </select>
    </div>
  </div>

  <div class="toggle-buttons">
    <button id="hoursBtn" class="active">Daylight Hours</button>
    <button id="elevBtn">Noon Elevation</button>
  </div>

  <table id="resultsTable">
    <thead><tr><th>Measure</th><th id="leftHead">Default City</th><th id="rightHead">Comparison City</th></tr></thead>
    <tbody id="tableBody"></tbody>
  </table>

  <canvas id="chartCanvas"></canvas>
</main>

<script>
/* ---------- Math utilities ---------- */
const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
function solarDeclination(day){return 23.44*Math.sin(toRad((360/365)*(day-81))); }
function daylightHours(lat,day){const decR=toRad(solarDeclination(day)),latR=toRad(lat);
 const cosH=-Math.tan(latR)*Math.tan(decR); if(cosH>=1)return 0;if(cosH<=-1)return 24;
 const H=Math.acos(cosH);return(2*toDeg(H))/15;}
function noonElevation(lat,day){const dec=solarDeclination(day);return 90-Math.abs(lat-dec);}
function dayOfYear(dt){return Math.floor((dt-new Date(dt.getFullYear(),0,0))/86400000);}
function dateFromDay(y,d){return new Date(y,0,d);}
function fmtMMDDYYYY(date){const mm=String(date.getMonth()+1).padStart(2,'0');const dd=String(date.getDate()).padStart(2,'0');return`${mm}/${dd}/${date.getFullYear()}`;}
function findEquivalentDate(lat,targetHours,refDay,year){let best=null,bestDiff=1e9;
 for(let d=1;d<=365;d++){if(Math.abs(d-refDay)<5)continue;
 const diff=Math.abs(daylightHours(lat,d)-targetHours);
 if(diff<bestDiff){bestDiff=diff;best=d;}}return best?dateFromDay(year,best):null;}
function fmtHoursMin(h){const hrs=Math.floor(h);const mins=Math.round((h-hrs)*60);
 return `${hrs} hr ${mins.toString().padStart(2,'0')} min`;}

/* ---------- Local time utilities ---------- */
function getTimeZoneAbbr(tz){
  try{const fmt=new Intl.DateTimeFormat('en-US',{timeZone:tz,timeZoneName:'short'});
  return fmt.formatToParts(new Date()).find(p=>p.type==='timeZoneName').value;}
  catch{return'';}
}
function getTimes(lat,lon,day,tz){
 const dec=toRad(solarDeclination(day)),latR=toRad(lat),solarDep=toRad(-0.83);
 const cosH=(Math.sin(solarDep)-Math.sin(latR)*Math.sin(dec))/(Math.cos(latR)*Math.cos(dec));
 if(cosH>1||cosH<-1)return{sunrise:'—',sunset:'—',hrs:0};
 const H=Math.acos(cosH);const Hh=toDeg(H)/15;const daylight=2*Hh;
 const hr=(deg)=>{const d=new Date(Date.UTC(2024,0,day,deg,0,0));
  return d.toLocaleTimeString('en-US',{timeZone:tz,hour:'2-digit',minute:'2-digit'});}
 const sunrise=hr(12-Hh),sunset=hr(12+Hh);
 return{sunrise,sunset,hrs:daylight};
}

/* ---------- Elevation arc ---------- */
function arcSVG(lat,day,color){
 const elev=noonElevation(lat,day);
 const R=32,a=Math.min(90,Math.max(0,elev))*Math.PI/180;
 const x=30+R*Math.cos(Math.PI-a),y=34-R*Math.sin(Math.PI-a);
 return `<svg viewBox='0 0 70 40'>
   <path d='M4 34 A32 32 0 0 1 64 34' stroke='#c9d3e3' stroke-width='1.2' fill='none'/>
   <line x1='30' y1='34' x2='${x.toFixed(1)}' y2='${y.toFixed(1)}' stroke='${color}' stroke-width='3'/>
   <circle cx='${x.toFixed(1)}' cy='${y.toFixed(1)}' r='4.2' fill='${color}'/>
  </svg><div>${elev.toFixed(1)}°</div>`;
}

/* ---------- Table build ---------- */
function buildTable(base,comp,day){
 const body=document.getElementById('tableBody');body.innerHTML='';
 const tb1=getTimes(base.lat,base.lon,day,base.tz),tb2=getTimes(comp.lat,comp.lon,day,comp.tz);
 const ab1=getTimeZoneAbbr(base.tz),ab2=getTimeZoneAbbr(comp.tz);
 const rows=[
   ['Latitude',base.lat.toFixed(2),comp.lat.toFixed(2)],
   ['Longitude',base.lon.toFixed(2),comp.lon.toFixed(2)],
   ['Noon Elevation',arcSVG(base.lat,day,'#0b5fb3'),arcSVG(comp.lat,day,'#f28e2b')],
   ['Sunrise',`${tb1.sunrise} ${ab1}`,`${tb2.sunrise} ${ab2}`],
   ['Sunset',`${tb1.sunset} ${ab1}`,`${tb2.sunset} ${ab2}`],
   ['Daylight',fmtHoursMin(tb1.hrs),fmtHoursMin(tb2.hrs)]
 ];
 rows.forEach(r=>{
   const tr=document.createElement('tr');
   tr.innerHTML=`<td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td>`;
   body.appendChild(tr);
 });
 document.getElementById('leftHead').textContent=`${base.name}`;
 document.getElementById('rightHead').textContent=`${comp.name}`;
}

/* ---------- Chart ---------- */
let chart,mode='hours';
function drawChart(base,comp){
 const ctx=document.getElementById('chartCanvas').getContext('2d');
 const days=Array.from({length:365},(_,i)=>i+1);
 const fn=mode==='hours'?daylightHours:noonElevation;
 const lbl=mode==='hours'?'Daylight Hours':'Noon Elevation (°)';
 const yCfg=mode==='hours'?{min:5,max:20}:{min:0,max:90};
 const ds1={label:base.name,data:days.map(d=>fn(base.lat,d)),borderColor:'#0b5fb3',borderWidth:2,tension:.25,fill:false,pointRadius:0};
 const ds2={label:comp.name,data:days.map(d=>fn(comp.lat,d)),borderColor:'#f28e2b',borderWidth:2,tension:.25,fill:false,pointRadius:0};
 if(chart)chart.destroy();
 chart=new Chart(ctx,{type:'line',data:{labels:days,datasets:[ds1,ds2]},
  options:{responsive:true,plugins:{legend:{display:true,position:'bottom'}},
  scales:{x:{display:false},y:{title:{display:true,text:lbl},...yCfg}}}});
}

/* ---------- Core update ---------- */
function updateAll(){
 const base={lat:userLat,lon:userLon,tz:userTZ,name:userName};
 const sel=document.getElementById('compareCity').value.split(',');
 const comp={lat:+sel[0],lon:+sel[1],tz:sel[2],name:`${sel[3]}, ${sel[4]}`};
 const date=new Date(document.getElementById('dateInput').value);
 const day=dayOfYear(date);
 // Equivalent date based on base city daylight
 const eqDate=findEquivalentDate(base.lat,daylightHours(base.lat,day),day,date.getFullYear());
 document.getElementById('equivDate').value=eqDate?fmtMMDDYYYY(eqDate):'—';
 buildTable(base,comp,day);
 drawChart(base,comp);
}

/* ---------- Location defaults ---------- */
let userLat=27.95,userLon=-82.46,userTZ='America/New_York',userName='Tampa, FL';
function init(){
 const today=new Date();document.getElementById('dateInput').value=today.toISOString().slice(0,10);
 updateAll();
}

/* ---------- Event wiring ---------- */
document.getElementById('dateInput').addEventListener('change',updateAll);
document.getElementById('compareCity').addEventListener('change',updateAll);
document.getElementById('hoursBtn').addEventListener('click',()=>{
 mode='hours';hoursBtn.classList.add('active');elevBtn.classList.remove('active');updateAll();});
document.getElementById('elevBtn').addEventListener('click',()=>{
 mode='elev';elevBtn.classList.add('active');hoursBtn.classList.remove('active');updateAll();});
window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
