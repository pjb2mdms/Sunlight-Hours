<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sunlight Angle Comparator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      color: #222;
    }
    header {
      background: #004c91;
      color: white;
      text-align: center;
      padding: 1rem 0;
    }
    main {
      background: white;
      max-width: 1100px;
      margin: 1.5rem auto;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0;
    }

    .date-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    label {
      font-weight: bold;
    }
    input[type="date"], input[readonly] {
      padding: 0.4rem;
      font-size: 1rem;
      margin-left: 0.3rem;
    }

    .city-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.3rem;
      margin-bottom: 0.8rem;
    }
    button {
      background: #004c91;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 1.5rem;
    }
    button:hover {
      background: #0060b4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
      font-size: 0.95rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem;
      text-align: center;
    }
    th.label-col, td.label-col {
      background: #f9f9f9;
      text-align: left;
      font-weight: bold;
      width: 140px;
    }
    th.city-col {
      background: #f0f0f0;
      font-weight: bold;
    }
    td svg {
      width: 60px;
      height: 30px;
    }
    canvas {
      width: 100% !important;
      height: 400px !important;
      margin-top: 1.2rem;
    }
  </style>
</head>

<body>
  <header>
    <h1>Sunlight Angle Comparator</h1>
    <p>Compare daylight hours and noon elevation across cities</p>
  </header>

  <main>
    <div class="date-row">
      <div>
        <label for="dateInput">Selected Date:</label>
        <input type="date" id="dateInput" value="2025-06-21">
      </div>
      <div>
        <label for="equivDate">Equivalent Date:</label>
        <input type="text" id="equivDate" readonly value="—">
      </div>
    </div>

    <h2>Select Cities:</h2>
    <div class="city-list" id="cityList"></div>
    <button onclick="compareCities()">Compare</button>

    <table id="resultsTable">
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>

    <h2>Daylight Duration Chart</h2>
    <canvas id="daylightChart"></canvas>
  </main>

  <script>
    /* ---------- Data ---------- */
    const cityData = {
      "Fairbanks, AK": { abbr: "FAI", lat: 64.84, lon: -147.72 },
      "St Andrews, Scotland": { abbr: "STA", lat: 56.34, lon: -2.80 },
      "Hanover, NH": { abbr: "HAN", lat: 43.70, lon: -72.29 },
      "East Longmeadow, MA": { abbr: "ELM", lat: 42.06, lon: -72.51 },
      "Crozet, VA": { abbr: "CRZ", lat: 38.07, lon: -78.70 },
      "Nashville, TN": { abbr: "BNA", lat: 36.16, lon: -86.78 },
      "Asheville, NC": { abbr: "AVL", lat: 35.60, lon: -82.55 },
      "Houston, TX": { abbr: "HOU", lat: 29.76, lon: -95.37 },
      "Tampa, FL": { abbr: "TPA", lat: 27.95, lon: -82.46 }
    };

    const sortedCities = Object.entries(cityData)
      .sort((a,b) => b[1].lat - a[1].lat);

    const cityList = document.getElementById("cityList");
    sortedCities.forEach(([name]) => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${name}"> ${name}`;
      cityList.appendChild(label);
    });

    /* ---------- Core math ---------- */
    const toRad = d => d * Math.PI / 180;
    const toDeg = r => r * 180 / Math.PI;

    function solarDeclination(day) {
      return 23.44 * Math.sin(toRad((360 / 365) * (day - 81)));
    }
    function daylightHours(lat, day) {
      const dec = toRad(solarDeclination(day));
      const latR = toRad(lat);
      const cosH = -Math.tan(latR) * Math.tan(dec);
      if (cosH >= 1) return 0;
      if (cosH <= -1) return 24;
      const H = Math.acos(cosH);
      return (2 * toDeg(H)) / 15;
    }
    function noonElevation(lat, day) {
      const dec = solarDeclination(day);
      return 90 - Math.abs(lat - dec);
    }
    function dayOfYear(date) {
      const start = new Date(date.getFullYear(), 0, 0);
      const diff = date - start + (start.getTimezoneOffset() - date.getTimezoneOffset()) * 60000;
      return Math.floor(diff / 86400000);
    }
    function findEquivalentDate(lat, targetHours, refDay, year) {
      let bestDay = null, bestDiff = 999;
      for (let d = 1; d <= 365; d++) {
        if (Math.abs(d - refDay) < 5) continue;
        const diff = Math.abs(daylightHours(lat, d) - targetHours);
        if (diff < bestDiff) {
          bestDiff = diff;
          bestDay = d;
        }
      }
      return bestDay ? new Date(year, 0, bestDay) : null;
    }
    function formatDate(date) {
      const mm = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const yyyy = date.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    /* ---------- Table builder ---------- */
    function buildTable(selected, refDay) {
      const head = document.getElementById("tableHead");
      const body = document.getElementById("tableBody");
      head.innerHTML = "";
      body.innerHTML = "";

      const headRow = document.createElement("tr");
      headRow.innerHTML = `<th class="label-col"></th>` +
        selected.map(city => `<th class="city-col">${cityData[city].abbr}</th>`).join('');
      head.appendChild(headRow);

      const addRow = (label, fn) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td class="label-col">${label}</td>` +
          selected.map(c => `<td>${fn(c)}</td>`).join('');
        body.appendChild(tr);
      };

      addRow("Latitude", c => cityData[c].lat.toFixed(2));
      addRow("Longitude", c => cityData[c].lon.toFixed(2));
      addRow("Noon Elev (°)", c => noonElevation(cityData[c].lat, refDay).toFixed(1));
      addRow("Daylight (hrs)", c => daylightHours(cityData[c].lat, refDay).toFixed(2));
    }

    /* ---------- Chart.js (Enhanced Line Graph) ---------- */
    let daylightChart;

    function plotChart(selected, eqDateObj, refDay) {
      const ctx = document.getElementById('daylightChart').getContext('2d');
      const days = Array.from({length:365}, (_,i)=>i+1);
      const datasets = selected.map(city => {
        const lat = cityData[city].lat;
        const data = days.map(d => daylightHours(lat, d));
        const color = `hsl(${Math.random()*360},70%,50%)`;
        return { label: cityData[city].abbr, data, borderColor: color, fill: false, tension: 0.2 };
      });

      if (daylightChart) daylightChart.destroy();

      const annotations = {
        selectedDate: {
          type: 'line', xMin: refDay, xMax: refDay,
          borderColor: 'black', borderWidth: 2,
          label: { enabled: true, content: 'Selected', position: 'start' }
        }
      };
      if (eqDateObj) {
        annotations.equivalentDate = {
          type: 'line', xMin: dayOfYear(eqDateObj), xMax: dayOfYear(eqDateObj),
          borderColor: 'red', borderWidth: 2,
          label: { enabled: true, content: 'Equivalent', position: 'start' }
        };
      }

      const months = [1,32,60,91,121,152,182,213,244,274,305,335];
      const monthLabels = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

      daylightChart = new Chart(ctx, {
        type: 'line',
        data: { labels: days, datasets },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            annotation: { annotations },
            title: { display: false }
          },
          scales: {
            x: {
              title: { display: true, text: 'Month' },
              ticks: {
                callback: function(value) {
                  const day = days[value];
                  for (let i = 0; i < months.length; i++) {
                    if (Math.abs(day - months[i]) < 2) return monthLabels[i];
                  }
                  return "";
                },
                autoSkip: false,
                maxRotation: 0,
                stepSize: 30
              }
            },
            y: {
              title: { display: true, text: 'Daylight Hours' },
              min: 5, max: 20
            }
          }
        },
        plugins: [Chart.registry.getPlugin('annotation')]
      });
    }

    /* ---------- Main handler ---------- */
    function compareCities() {
      const selected = Array.from(document.querySelectorAll("#cityList input:checked")).map(cb => cb.value);
      if (selected.length === 0) { alert("Select at least one city."); return; }

      const dateVal = document.getElementById("dateInput").value;
      const date = new Date(dateVal);
      const refDay = dayOfYear(date);
      const year = date.getFullYear();

      const refCity = selected[0];
      const refLat = cityData[refCity].lat;
      const refHours = daylightHours(refLat, refDay);
      const eqDateObj = findEquivalentDate(refLat, refHours, refDay, year);
      document.getElementById("equivDate").value = eqDateObj ? formatDate(eqDateObj) : "—";

      buildTable(selected, refDay);
      plotChart(selected, eqDateObj, refDay);
    }
  </script>
</body>
</html>
