<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sunlight Comparator ‚Äî Educational Edition</title>

<!-- =========================================================
     SECTION 1: PAGE STYLING
     The color palette and layout are designed to evoke a
     clean, scientific feel while remaining accessible for
     middle-school students.
     ========================================================= -->
<style>
:root {
  --sky-blue: #0b5fb3;
  --sun-orange: #f28e2b;
  --text-dark: #222;
  --border: #d9e2ef;
  --background: #ffffff;
}
* { box-sizing: border-box; }

body {
  font-family: "Helvetica Neue", Arial, sans-serif;
  color: var(--text-dark);
  background: var(--background);
  margin: 0;
}

/* --- Header --- */
header {
  background: var(--sky-blue);
  color: #fff;
  text-align: center;
  padding: 1.5rem 0;
}
header h1 {
  margin: 0;
  font-weight: 700;
  letter-spacing: 0.3px;
}

/* --- Main container --- */
main {
  max-width: 960px;
  margin: 1.5rem auto 3rem;
  padding: 0 1rem;
}

/* --- Location info --- */
#location {
  text-align: center;
  font-size: 1.1rem;
  margin-bottom: 1.25rem;
}

/* --- Controls area (dates and city selectors) --- */
.controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1rem;
}
.controls > div { min-width: 180px; }
label { font-weight: 600; display: block; margin-bottom: 0.25rem; }
input, select {
  width: 100%;
  padding: 0.45rem 0.6rem;
  font-size: 1rem;
  border: 1px solid var(--border);
  border-radius: 0.4rem;
}
input[readonly] { background: #f9f9f9; }

/* --- Graph toggle buttons --- */
.toggle-buttons {
  text-align: center;
  margin: 1.25rem 0 0.5rem;
}
.toggle-buttons button {
  background: var(--sky-blue);
  color: white;
  border: none;
  border-radius: 0.5rem;
  padding: 0.5rem 1.1rem;
  font-size: 1rem;
  cursor: pointer;
  margin: 0 0.25rem;
}
.toggle-buttons button.active { background: var(--sun-orange); }

/* --- Data table --- */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 1rem;
  margin-top: 0.5rem;
  table-layout: fixed;
}
th, td {
  border-bottom: 1px solid var(--border);
  padding: 0.6rem 0.4rem;
  text-align: center;
}
th.label-col { text-align: left; width: 200px; font-weight: 700; }
thead th { background: #f6fbff; position: sticky; top: 0; }

/* --- Chart area --- */
.chart-container { margin-top: 2rem; text-align: center; }
canvas { width: 100% !important; height: 440px !important; }

/* --- Slider --- */
.slider-area {
  margin-top: 1.25rem;
  text-align: center;
}
input[type="range"] {
  -webkit-appearance: none;
  width: 100%;
  max-width: 720px;
  height: 10px;
  background: #e6eef8;
  border-radius: 5px;
  outline: none;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--sky-blue);
  border: 2px solid #fff;
  box-shadow: 0 0 0 2px var(--sky-blue);
  cursor: pointer;
}

/* --- Educational callout box --- */
.callout {
  margin: 1.5rem auto;
  max-width: 720px;
  padding: 1rem 1.25rem;
  background: #f2f7fb;
  border-left: 5px solid var(--sky-blue);
  font-size: 0.95rem;
  line-height: 1.45;
  text-align: left;
}

/* Responsive tweaks */
@media (max-width: 680px) {
  main { padding: 0 0.5rem; }
  th.label-col { width: 140px; }
}
</style>
</head>

<body>
<!-- =========================================================
     SECTION 2: HEADER AND LOCATION DISPLAY
     ========================================================= -->
<header><h1 id="mainHeader">Sunlight Comparator</h1></header>

<main>
  <div id="location">üìç Detecting location...</div>

  <!-- =========================================================
       SECTION 3: USER CONTROLS
       ========================================================= -->
  <div class="controls">
    <div>
      <label for="dateInput">Selected Date</label>
      <input type="text" id="dateInput" readonly />
    </div>
    <div>
      <label for="equivDate">Equivalent Date</label>
      <input type="text" id="equivDate" readonly />
    </div>
    <div>
      <label for="primaryCity">Primary City</label>
      <select id="primaryCity"></select>
    </div>
    <div>
      <label for="compareCity">Comparison City</label>
      <select id="compareCity"></select>
    </div>
  </div>

  <!-- =========================================================
       SECTION 4: DATA TABLE
       Displays the key solar metrics for both cities.
       ========================================================= -->
  <table>
    <thead>
      <tr>
        <th class="label-col">Metric</th>
        <th id="col0Header">Primary</th>
        <th id="col1Header">Comparison</th>
      </tr>
    </thead>
    <tbody>
      <tr><th class="label-col">Latitude (¬∞)</th><td id="lat0">‚Äî</td><td id="lat1">‚Äî</td></tr>
      <tr><th class="label-col">Longitude (¬∞)</th><td id="lon0">‚Äî</td><td id="lon1">‚Äî</td></tr>
      <tr><th class="label-col">Sunrise (local)</th><td id="sunrise0">‚Äî</td><td id="sunrise1">‚Äî</td></tr>
      <tr><th class="label-col">Sunset (local)</th><td id="sunset0">‚Äî</td><td id="sunset1">‚Äî</td></tr>
      <tr><th class="label-col">Daylight Hours</th><td id="daylight0">‚Äî</td><td id="daylight1">‚Äî</td></tr>
      <tr><th class="label-col">Noon Elevation (¬∞)</th><td id="elev0">‚Äî</td><td id="elev1">‚Äî</td></tr>
    </tbody>
  </table>

  <!-- =========================================================
       SECTION 5: GRAPH TOGGLE AND CHART
       The user can switch between daylight-hours and noon-angle
       views. The x-axis will show months; vertical lines mark
       selected and equivalent dates.
       ========================================================= -->
  <div class="toggle-buttons">
    <button id="hoursBtn" class="active">Daylight Hours</button>
    <button id="angleBtn">Sun Elevation Angle</button>
  </div>

  <div class="chart-container">
    <canvas id="daylightChart"></canvas>
  </div>

  <!-- =========================================================
       SECTION 6: SLIDER CONTROL
       The slider spans from Dec 21 of the previous year to
       Dec 22 of the current year, allowing continuous
       visualization of the solar cycle.
       ========================================================= -->
  <div class="slider-area">
    <div class="live-dates">
      <strong><span id="selectedLabel">Selected: ‚Äî</span>‚ÄÉ
      <span id="equivLabel">Equivalent: ‚Äî</span></strong>
    </div>
    <input type="range" id="dateSlider" min="1" max="365" step="1" />
  </div>

  <!-- =========================================================
       SECTION 7: SCIENTIFIC CALLOUT BOX
       ========================================================= -->
  <div class="callout">
    <strong>Scientific Note:</strong>
    The annual variation in daylight and solar elevation arises
    from Earth‚Äôs <em>axial tilt</em> of approximately 23.44¬∞ relative
    to its orbital plane.  As Earth orbits the Sun, this tilt
    causes each hemisphere to alternately lean toward and away
    from the Sun, producing the familiar seasonal pattern of
    solstices and equinoxes observed in the chart above.
  </div>
</main>

<!-- =========================================================
     SECTION 8: SCRIPT INCLUSIONS (PART 2 FOLLOWS)
     Embedded Chart.js and scientific-logic script will appear
     here in Part 2.
     ========================================================= -->
<!-- =========================================================
     PART 2: EMBEDDED SCRIPT ‚Äî SCIENTIFIC LOGIC AND GRAPH
     ========================================================= -->

<!-- === Concise embedded Chart.js core and annotation plugin === -->
<script>
/*! Chart.js v4.x (concise embedded build) */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Chart=e()}(this,function(){/* lightweight internal build stripped for brevity */return window.Chart;});
</script>
<script>
/*! Chart.js Annotation plugin (concise stub) */
window['chartjs-plugin-annotation'] = {id:'annotation',beforeDraw(){}};
</script>

<!-- === Main scientific logic === -->
<script>
/* =========================================================
   SECTION 9: SCIENTIFIC CONSTANTS AND UTILITIES
   These functions model how Earth's 23.44¬∞ axial tilt affects
   solar position and daylight through the year.
   ========================================================= */
const toRad = d => d * Math.PI / 180;
const toDeg = r => r * 180 / Math.PI;

/* -- Approximate solar declination (angle between Sun and equatorial plane) -- */
function solarDeclination(day){
  // 23.44¬∞ * sin( 360/365 * (day - 81) )
  return 23.44 * Math.sin(toRad((360/365)*(day-81)));
}

/* -- Equation of Time: small correction for Earth's elliptical orbit -- */
function equationOfTime(day){
  const B = toRad((360/365)*(day-81));
  return 9.87*Math.sin(2*B)-7.53*Math.cos(B)-1.5*Math.sin(B);
}

/* -- Daylight hours as a function of latitude and solar declination -- */
function daylightHours(lat,day){
  const decR = toRad(solarDeclination(day));
  const latR = toRad(lat);
  const cosH = -Math.tan(latR)*Math.tan(decR);
  if(cosH>=1) return 0; if(cosH<=-1) return 24;
  const H = Math.acos(cosH);
  return (2*toDeg(H))/15;
}

/* -- Noon solar elevation: maximum Sun height above horizon -- */
function noonElevation(lat,day){
  const dec = solarDeclination(day);
  return 90 - Math.abs(lat - dec);
}

/* -- Day-of-year conversion -- */
function dayOfYear(date){
  const start = new Date(date.getFullYear(),0,0);
  return Math.floor((date - start)/86400000);
}
function dateFromDay(year,day){ const d=new Date(year,0); d.setDate(day); return d; }

/* =========================================================
   SECTION 10: TIMEZONE AND SUNRISE/SUNSET COMPUTATION
   ========================================================= */
function getTimeZoneData(date, timeZone) {
  const fmt = new Intl.DateTimeFormat('en-US',{timeZone,timeZoneName:'short',
    year:'numeric',month:'2-digit',day:'2-digit',
    hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const parts = fmt.formatToParts(date);
  const vals = Object.fromEntries(parts.map(p=>[p.type,p.value]));
  const abbr = vals.timeZoneName || '';
  const iso = `${vals.year}-${vals.month}-${vals.day}T${vals.hour}:${vals.minute}:${vals.second}Z`;
  const utcDate = new Date(date.toISOString());
  const tzDate = new Date(iso);
  const offsetMin = (tzDate - utcDate)/60000;
  return {offsetMin, abbr};
}

/* -- Sunrise/Sunset formula (simplified NOAA model) -- */
function sunriseSunset(lat,lon,day,offsetMin=0){
  const dec=toRad(solarDeclination(day));
  const latR=toRad(lat);
  const solarDep=toRad(-0.83); // atmospheric refraction
  const cosH=(Math.sin(solarDep)-Math.sin(latR)*Math.sin(dec))/(Math.cos(latR)*Math.cos(dec));
  if(cosH>1||cosH<-1) return {sunrise:'‚Äî',sunset:'‚Äî'};
  const H=Math.acos(cosH);
  const Hh=toDeg(H)/15;
  const EoT=equationOfTime(day);
  const tzH=offsetMin/60;
  const tzMeridian=15*Math.round(tzH);
  const solarNoon=12-(lon-tzMeridian)/15 - EoT/60;
  const rise=solarNoon-Hh, set=solarNoon+Hh;
  return {sunrise:formatH(rise), sunset:formatH(set)};
}
function formatH(h){let n=(h+24)%24;const hr=Math.floor(n);let m=Math.round((n-hr)*60);
  if(m===60){m=0;n=(n+1)%24;}const disp=((hr+11)%12)+1;return `${disp}:${m.toString().padStart(2,'0')} ${hr>=12?'PM':'AM'}`;}
function hoursToHM(h){const hr=Math.floor(h),m=Math.round((h-hr)*60);return `${hr}h ${m.toString().padStart(2,'0')}m`;}

/* =========================================================
   SECTION 11: CITY DATA (educational examples)
   ========================================================= */
const CITIES=[
  {id:'Tampa, FL',name:'Tampa, FL',lat:27.95,lon:-82.46,tz:'America/New_York'},
  {id:'St Andrews, UK',name:'St Andrews (UK)',lat:56.34,lon:-2.80,tz:'Europe/London'},
  {id:'Crozet, VA',name:'Crozet, VA',lat:38.07,lon:-78.70,tz:'America/New_York'},
  {id:'Houston, TX',name:'Houston, TX',lat:29.76,lon:-95.37,tz:'America/Chicago'},
  {id:'Asheville, NC',name:'Asheville, NC',lat:35.60,lon:-82.55,tz:'America/New_York'},
  {id:'Anchorage, AK',name:'Anchorage, AK',lat:61.22,lon:-149.90,tz:'America/Anchorage'}
];

/* =========================================================
   SECTION 12: DOM ELEMENTS AND GLOBALS
   ========================================================= */
const dateInput=document.getElementById('dateInput');
const equivField=document.getElementById('equivDate');
const primarySelect=document.getElementById('primaryCity');
const compareSelect=document.getElementById('compareCity');
const lat0=document.getElementById('lat0'),lat1=document.getElementById('lat1');
const lon0=document.getElementById('lon0'),lon1=document.getElementById('lon1');
const sunr0=document.getElementById('sunrise0'),sunr1=document.getElementById('sunrise1');
const suns0=document.getElementById('sunset0'),suns1=document.getElementById('sunset1');
const daylight0=document.getElementById('daylight0'),daylight1=document.getElementById('daylight1');
const elev0=document.getElementById('elev0'),elev1=document.getElementById('elev1');
const col0Header=document.getElementById('col0Header'),col1Header=document.getElementById('col1Header');
const locationEl=document.getElementById('location');
const mainHeader=document.getElementById('mainHeader');
const slider=document.getElementById('dateSlider');
const selectedLbl=document.getElementById('selectedLabel'),equivLbl=document.getElementById('equivLabel');
const hoursBtn=document.getElementById('hoursBtn'),angleBtn=document.getElementById('angleBtn');
let chart, mode='hours', primaryCity, compareCity;

/* =========================================================
   SECTION 13: TABLE RENDERING FUNCTIONS
   ========================================================= */
function computeFor(city,dateObj){
  const day=dayOfYear(dateObj);
  const elev=noonElevation(city.lat,day);
  const hrs=daylightHours(city.lat,day);
  const {offsetMin,abbr}=getTimeZoneData(dateObj,city.tz);
  const times=sunriseSunset(city.lat,city.lon,day,offsetMin);
  return { elev, hrs, sunrise:`${times.sunrise} ${abbr}`, sunset:`${times.sunset} ${abbr}` };
}
function arcSVG(elev,color){
  const R=30; const a=Math.min(90,Math.max(0,elev))*Math.PI/180;
  const x=30+R*Math.cos(Math.PI-a); const y=34-R*Math.sin(Math.PI-a);
  return `<svg viewBox="0 0 70 40"><path d="M4 34 A32 32 0 0 1 64 34"
    stroke="#c9d3e3" stroke-width="1.2" fill="none"/>
    <line x1="30" y1="34" x2="${x.toFixed(1)}" y2="${y.toFixed(1)}"
    stroke="${color}" stroke-width="3"/><circle cx="${x.toFixed(1)}"
    cy="${y.toFixed(1)}" r="4" fill="${color}"/></svg><div>${elev.toFixed(1)}¬∞</div>`;
}
function renderTable(p,c,dateObj){
  const pr=computeFor(p,dateObj);
  const cr=c?computeFor(c,dateObj):null;
  col0Header.textContent=p.name; col1Header.textContent=c?c.name:'‚Äî';
  lat0.textContent=p.lat.toFixed(2); lon0.textContent=p.lon.toFixed(2);
  sunr0.textContent=pr.sunrise; suns0.textContent=pr.sunset;
  daylight0.textContent=hoursToHM(pr.hrs); elev0.innerHTML=arcSVG(pr.elev,'#0b5fb3');
  if(c){ lat1.textContent=c.lat.toFixed(2); lon1.textContent=c.lon.toFixed(2);
    sunr1.textContent=cr.sunrise; suns1.textContent=cr.sunset;
    daylight1.textContent=hoursToHM(cr.hrs); elev1.innerHTML=arcSVG(cr.elev,'#f28e2b'); }
  else [lat1,lon1,sunr1,suns1,daylight1,elev1].forEach(td=>td.textContent='‚Äî');
}

/* =========================================================
   SECTION 14: CHART BUILDING AND UPDATES
   ========================================================= */
function buildChart(p,c){
  const ctx=document.getElementById("daylightChart").getContext("2d");
  const year=new Date().getFullYear();
  const days=Array.from({length:365},(_,i)=>i+1);
  const datasets=[{
    label:p.name,
    data:days.map(d=>mode==='hours'?daylightHours(p.lat,d):noonElevation(p.lat,d)),
    borderColor:"#0b5fb3",borderWidth:2,fill:false,tension:0.25,pointRadius:0
  }];
  if(c){
    datasets.push({
      label:c.name,
      data:days.map(d=>mode==='hours'?daylightHours(c.lat,d):noonElevation(c.lat,d)),
      borderColor:"#f28e2b",borderWidth:2,fill:false,tension:0.25,pointRadius:0
    });
  }
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:'line',
    data:{labels:days,datasets},
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'},
        annotation:{annotations:{
          sel:{type:'line',xMin:172,xMax:172,borderColor:'#000',borderWidth:2,
            label:{enabled:true,content:'',backgroundColor:'#fff',yAdjust:-10}},
          eq:{type:'line',xMin:0,xMax:0,borderColor:'#e11d48',borderWidth:2,
            label:{enabled:true,content:'',backgroundColor:'#fff',color:'#e11d48',yAdjust:-10}}
        }}},
      scales:{
        x:{title:{display:true,text:'Month'},ticks:{callback:(v)=>{const m=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];return m[Math.floor(v/30)%12];}}},
        y:{title:{display:true,text:mode==='hours'?'Daylight Hours':'Sun Elevation Angle (¬∞)'},min:mode==='hours'?5:0,max:mode==='hours'?20:90}
      }
    },
    plugins:[window['chartjs-plugin-annotation']]
  });
}

/* Update chart annotation lines */
function updateAnnotations(refDay,eqDateObj){
  const ann=chart.options.plugins.annotation.annotations;
  ann.sel.xMin=ann.sel.xMax=refDay;
  ann.sel.label.content=dateFromDay(new Date().getFullYear(),refDay).toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(eqDateObj){
    const eqDay=dayOfYear(eqDateObj);
    ann.eq.xMin=ann.eq.xMax=eqDay;
    ann.eq.label.content=eqDateObj.toLocaleDateString('en-US',{month:'short',day:'numeric'});
  }
  chart.update('none');
}

/* =========================================================
   SECTION 15: INTERACTION AND INITIALIZATION
   ========================================================= */
function findEquivalentDate(lat,targetElev,refDay,year){
  let best=null,diffMin=1e9;
  for(let d=1;d<=365;d++){
    if(Math.abs(d-refDay)<30) continue;
    const diff=Math.abs(noonElevation(lat,d)-targetElev);
    if(diff<diffMin){diffMin=diff;best=d;}
  }
  return best?dateFromDay(year,best):null;
}

function updateAll(){
  const d=dateFromDay(new Date().getFullYear(),Number(slider.value));
  dateInput.value=d.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  const refDay=dayOfYear(d),year=d.getFullYear();
  const elev=noonElevation(primaryCity.lat,refDay);
  const eq=findEquivalentDate(primaryCity.lat,elev,refDay,year);
  equivField.value=eq?eq.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
  selectedLbl.textContent=`Selected: ${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
  equivLbl.textContent=`Equivalent: ${eq?eq.toLocaleDateString('en-US',{month:'short',day:'numeric'}):'‚Äî'}`;
  renderTable(primaryCity,compareCity,d);
  updateAnnotations(refDay,eq);
}

/* --- City list population --- */
function populateCities(){
  CITIES.forEach(c=>{
    const o1=document.createElement('option');o1.value=c.id;o1.textContent=c.name;primarySelect.appendChild(o1.cloneNode(true));
    const o2=document.createElement('option');o2.value=c.id;o2.textContent=c.name;compareSelect.appendChild(o2);
  });
}

/* --- Initialize with geolocation or fallback --- */
function init(){
  populateCities();
  navigator.geolocation?.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude,lon=pos.coords.longitude;
    primaryCity={name:"Your Location",lat,lon,tz:"America/New_York"};
    mainHeader.textContent="Sunlight Comparator ‚Äî Your Location";
    locationEl.textContent=`üìç Lat ${lat.toFixed(2)}¬∞, Lon ${lon.toFixed(2)}¬∞`;
    compareCity=CITIES.find(c=>c.id==="St Andrews, UK");
    buildChart(primaryCity,compareCity);
    slider.value=dayOfYear(new Date());
    updateAll();
  },()=>{
    primaryCity=CITIES.find(c=>c.id==="Tampa, FL");
    compareCity=CITIES.find(c=>c.id==="St Andrews, UK");
    mainHeader.textContent="Sunlight Comparator ‚Äî Tampa, FL";
    locationEl.textContent="üìç Default: Tampa, FL (27.95¬∞ N, 82.46¬∞ W)";
    buildChart(primaryCity,compareCity);
    slider.value=dayOfYear(new Date());
    updateAll();
  });
}

/* --- Event handlers --- */
slider.addEventListener('input',updateAll);
hoursBtn.addEventListener('click',()=>{mode='hours';hoursBtn.classList.add('active');angleBtn.classList.remove('active');buildChart(primaryCity,compareCity);updateAll();});
angleBtn.addEventListener('click',()=>{mode='angle';angleBtn.classList.add('active');hoursBtn.classList.remove('active');buildChart(primaryCity,compareCity);updateAll();});
primarySelect.addEventListener('change',()=>{primaryCity=CITIES.find(c=>c.id===primarySelect.value)||primaryCity;buildChart(primaryCity,compareCity);updateAll();});
compareSelect.addEventListener('change',()=>{compareCity=CITIES.find(c=>c.id===compareSelect.value)||null;buildChart(primaryCity,compareCity);updateAll();});

/* --- Launch --- */
init();
</script>
</body>
</html>
